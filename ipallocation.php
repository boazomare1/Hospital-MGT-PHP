<?phpsession_start();include ("includes/loginverify.php");include ("db/db_connect.php");$ipaddress = $_SERVER['REMOTE_ADDR'];$updatedate = date('Y-m-d');$username = $_SESSION['username'];$docno = $_SESSION['docno'];$companyanum = $_SESSION['companyanum'];$companyname = $_SESSION['companyname'];$transactiondatefrom = date('Y-m-d', strtotime('-1 month'));$transactiondateto = date('Y-m-d');$updatetime = date('H:i:s');$docno = $_SESSION['docno'];$errmsg = "";$banum = "1";$supplieranum = "";$custid = "";$custname = "";$balanceamount = "0.00";$openingbalance = "0.00";$searchsuppliername = "";$cbsuppliername = "";$query1 = "select employeecode from master_employee where  status = 'Active' AND username like '%$username%'";$exec1 = mysqli_query($GLOBALS["___mysqli_ston"], $query1) or die ("Error in Query11".mysqli_error($GLOBALS["___mysqli_ston"]));$res1 = mysqli_fetch_array($exec1);$res1employeename  = $res1["employeecode"];if (isset($_REQUEST["cbfrmflag2"])) { $cbfrmflag2 = $_REQUEST["cbfrmflag2"]; } else { $cbfrmflag2 = ""; }//$cbfrmflag2 = $_REQUEST['cbfrmflag2'];if (isset($_REQUEST["frmflag1"])) { $frmflag1 = $_REQUEST["frmflag1"]; } else { $frmflag1 = ""; }//$frmflag2 = $_POST['frmflag2'];if ($frmflag1 == 'frmflag1'){       $paynowbillprefix7 = 'BA-';$paynowbillprefix17=strlen($paynowbillprefix7);$query27 = "select * from ip_bedallocation order by auto_number desc limit 0, 1";$exec27 = mysqli_query($GLOBALS["___mysqli_ston"], $query27) or die ("Error in Query27".mysqli_error($GLOBALS["___mysqli_ston"]));$res27 = mysqli_fetch_array($exec27);$billnumber7 = $res27["docno"];$billdigit7=strlen($billnumber7);if ($billnumber7 == ''){	$billnumbercode7 =$paynowbillprefix7.'1';		$openingbalance = '0.00';}else{	$billnumber7 = $res27["docno"];	$billnumbercode7 = substr($billnumber7,$paynowbillprefix17, $billdigit7);	//echo $billnumbercode;	$billnumbercode7 = intval($billnumbercode7);	$billnumbercode7 = $billnumbercode7 + 1;	$maxanum7 = $billnumbercode7;	$billnumbercode7 = $paynowbillprefix7 .$maxanum7;		}		$patientname = $_REQUEST['patientname'];		$patientcode = $_REQUEST['patientcode'];		$visitcode = $_REQUEST['visitcode'];		$accname = $_REQUEST['accname'];		$patientlocationcode = $_REQUEST['locationcode'];	$patientlocationname =	$_REQUEST['patientlocationname'];		$ward = $_REQUEST['ward'];		$bed = $_REQUEST['bed'];		$standbybed = $_REQUEST['standbybed'];        if(isset($_REQUEST['mcc_status']))		  $mcc_status = $_REQUEST['mcc_status'];		else			$mcc_status = 0;         if(isset($_REQUEST['mccnum']))		  $mccnum = $_REQUEST['mccnum'];		else			$mccnum = '';		if(isset($_REQUEST['op_visitcode']))		  $op_visitcode = $_REQUEST['op_visitcode'];		else			$op_visitcode = 0;				$query33 = "select * from ip_bedallocation where visitcode='$visitcode'";		$exec33 = mysqli_query($GLOBALS["___mysqli_ston"], $query33) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$num33 = mysqli_num_rows($exec33);		if($num33 == 0)		{		$query67 = "insert into ip_bedallocation(docno,patientname,patientcode,visitcode,accountname,ward,bed,standbybedstatus,recordtime,recorddate,ipaddress,username,locationcode)values('$billnumbercode7','$patientname','$patientcode','$visitcode','$accname','$ward','$bed','$standbybed','$updatetime','$updatedate','$ipaddress','$username','$patientlocationcode')";		$exec67 = mysqli_query($GLOBALS["___mysqli_ston"], $query67) or die(mysqli_error($GLOBALS["___mysqli_ston"]));							$query64 = "update master_ipvisitentry set bedallocation='completed' where patientcode='$patientcode' and visitcode='$visitcode' and locationcode='$patientlocationcode'";		$exec64 = mysqli_query($GLOBALS["___mysqli_ston"], $query64) or die(mysqli_error($GLOBALS["___mysqli_ston"]));				$query641 = "update master_ipvisitentry set deposit='completed' where patientcode='$patientcode' and visitcode='$visitcode' and locationcode='$patientlocationcode' and billtype='PAY NOW' and deposit=''";		$exec641 = mysqli_query($GLOBALS["___mysqli_ston"], $query641) or die(mysqli_error($GLOBALS["___mysqli_ston"]));				$query53 = "update master_bed set recordstatus='occupied' where ward='$ward' and auto_number='$bed' and locationcode='$patientlocationcode'";		$exec53 = mysqli_query($GLOBALS["___mysqli_ston"], $query53) or die(mysqli_error($GLOBALS["___mysqli_ston"]));				$account=$accname;		$patientfullname=$patientname;		$locationcode=$patientlocationcode;		$timeonly=$updatetime;		$currentdate=$updatedate;		$billtype= $_REQUEST['billtype'];			$paynowbillprefix = 'TP-';			$paynowbillprefix1=strlen($paynowbillprefix);			$query2 = "select * from iptest_procedures order by auto_number desc limit 0, 1";			$exec2 = mysqli_query($GLOBALS["___mysqli_ston"], $query2) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));			$res2 = mysqli_fetch_array($exec2);			$billnumber = $res2["docno"];			$billdigit=strlen($billnumber);			if ($billnumber == '')			{				$billnumbercode ='TP-'.'1';				$openingbalance = '0.00';			}			else			{				$billnumber = $res2["docno"];				$billnumbercode = substr($billnumber,$paynowbillprefix1, $billdigit);				//echo $billnumbercode;				$billnumbercode = intval($billnumbercode);				$billnumbercode = $billnumbercode + 1;							$maxanum = $billnumbercode;												$billnumbercode = 'TP-' .$maxanum;				$openingbalance = '0.00';				//echo $companycode;			}			$subtype = isset($_REQUEST['subtype'])?$_REQUEST['subtype']:'';				$get_tets=0;		$pharmfree = "No";		$count=isset($_REQUEST['medicine_count'])?$_REQUEST['medicine_count']:0;				$paynowbillprefix = 'IPMP-';	$paynowbillprefix1=strlen($paynowbillprefix);	$query2 = "select docno from ipmedicine_prescription order by auto_number desc limit 0, 1";	$exec2 = mysqli_query($GLOBALS["___mysqli_ston"], $query2) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));	$res2 = mysqli_fetch_array($exec2);	$billnumber = $res2["docno"];	$billdigit=strlen($billnumber);	if ($billnumber == '')	{		$med_billnumbercode ='IPMP-'.'1';		$openingbalance = '0.00';	}	else	{		$billnumber = $res2["docno"];		$med_billnumbercode = substr($billnumber,$paynowbillprefix1, $billdigit);		$med_billnumbercode = intval($med_billnumbercode);		$med_billnumbercode = $med_billnumbercode + 1;		$maxanum = $med_billnumbercode;				$med_billnumbercode = 'IPMP-' .$maxanum;	}						for($ij=1;$ij<=$count;$ij++){				if(isset($_REQUEST['medicinecheck'][$ij])){					$med_auto_number=$_REQUEST['medicineanum'][$ij];		$med_code=$_REQUEST['medicinecode'][$ij];		$med_name=$_REQUEST['medicinename'][$ij];		$med_qty=$_REQUEST['medicineqty'][$ij];		$med_rate=$_REQUEST['medicinerate'][$ij];		$med_amount=$_REQUEST['medicineamount'][$ij];				$medicinename = $med_name;		$medicinecode = $med_code;		$quantity = $med_qty;		$rate = $med_rate;		$amount = $med_amount ;		$batch='';		$dateonly=$updatedate;		$accountname = $accname;		$expirydate = '0000-00-00';		$starttime = '00:00:00';			$sess='am';					$frequency = '';		$dose = '';		$days = '';		$route = '';		$dischargemedicine = 'No';		$instructions = '';		$docnumber = '';		$queryfreestatus = "select pkg from master_medicine where itemcode='$med_code'";		$execfreestatus = mysqli_query($GLOBALS["___mysqli_ston"], $queryfreestatus) or die ("Error in freestatusQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));		if($rowfreestatus=mysqli_fetch_array($execfreestatus)){			if(strtolower($rowfreestatus['pkg'])=='yes'){				$pharmfree="Yes";			}			else				$pharmfree="No";		}		$query13 = "select * from master_consultationpharm  where medicinecode = '$medicinecode' and patientvisitcode='$op_visitcode' and patientcode='$patientcode' ";		$exec13 = mysqli_query($GLOBALS["___mysqli_ston"], $query13) or die ("Error in Query13".mysqli_error($GLOBALS["___mysqli_ston"]));		while($res13 = mysqli_fetch_array($exec13)){			$frequency = $res13['frequencycode'];			$dose = $res13['dose'];			$days = $res13['days'];			$route = $res13['route'];			$instructions = $res13['instructions'];			$medicineissue = $res13['medicineissue'];			$dosemeasure = $res13['dosemeasure'];			$docnumber = $res13['docnumber'];			if($mcc_status==1){				if($res13['amendstatus']=='2')				{				    $query_oppharmsub = "select itemcode from pharmacysales_details where itemcode = '$medicinecode' and visitcode='$op_visitcode' and patientcode='$patientcode'";					$exec_oppharm1=mysqli_query($GLOBALS["___mysqli_ston"], $query_oppharmsub) or die(mysqli_error($GLOBALS["___mysqli_ston"]));					if($row_oppharm1=mysqli_fetch_array($exec_oppharm1)) {					  $medicineissue = 'completed';					}				}			}		}		$locationcodeget = $patientlocationcode;		$locationnameget = $patientlocationname; 		$query86 ="insert into ipmedicine_prescription(itemname,itemcode,quantity,prescribed_quantity,rateperunit,totalrate,batchnumber,companyanum,patientcode,visitcode,patientname,username,ipaddress,date,account,docno,billtype,expirydate,starttime,session,frequency,dose,days,freestatus,route,dischargemedicine,medicineissue,instructions,locationcode,locationname,dosemeasure,mcc,issuedocno)values('$medicinename','$medicinecode','$quantity','$quantity','$rate','$amount','$batch','$companyanum','$patientcode','$visitcode','$patientname','$username','$ipaddress','$dateonly','$accountname','$med_billnumbercode','$billtype','$expirydate','$starttime','$sess','$frequency','$dose','$days','$pharmfree','$route','$dischargemedicine','$medicineissue','$instructions','".$locationcodeget."','".$locationnameget."','$dosemeasure','$mccnum','$docnumber')"; 		$exec86 = mysqli_query($GLOBALS["___mysqli_ston"], $query86) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$query87 ="insert into ipmedicine_issue(itemname,itemcode,quantity,rateperunit,totalrate,batchnumber,companyanum,patientcode,visitcode,patientname,username,ipaddress,date,account,docno,billtype,expirydate,starttime,session,frequency,dose,days,freestatus,route,dischargemedicine,instructions,locationcode,locationname,dosemeasure,mcc)values('$medicinename','$medicinecode','$quantity','$rate','$amount', '$batch','$companyanum','$patientcode','$visitcode','$patientname','$username','$ipaddress','$dateonly','$accountname','$med_billnumbercode','$billtype','$expirydate','$starttime','$sess','$frequency','$dose','$days','$pharmfree','$route','$dischargemedicine','$instructions','".$locationcodeget."','".$locationnameget."','$dosemeasure','$mccnum')";		$exec87 = mysqli_query($GLOBALS["___mysqli_ston"], $query87) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$get_tets++;		   if($mcc_status==1) {				$querylab3 = "select auto_number from master_consultationpharm where medicinecode = '$medicinecode' and patientvisitcode='$op_visitcode' and patientcode='$patientcode'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update master_consultationpharm set paymentstatus='ip admit',amount='0',amendstatus='3',medicineissue='completed' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				  @mysqli_query($GLOBALS["___mysqli_ston"], "update master_consultationpharmissue set paymentstatus='ip admit',amount='0',amendstatus='3' where auto_number='".$reslab3['auto_number']."'");				}				$querylab3 = "select auto_number from pharmacysales_details where itemcode = '$medicinecode' and visitcode='$op_visitcode' and patientcode='$patientcode'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update pharmacysales_details set visitcode='$visitcode',ipdocno='$med_billnumbercode',freestatus='$pharmfree',issuedfrom='ip' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				}				$querylab3 = "select auto_number from pharmacysalesreturn_details where itemcode = '$medicinecode' and visitcode='$op_visitcode' and patientcode='$patientcode'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update pharmacysalesreturn_details set visitcode='$visitcode',ipdocno='$med_billnumbercode',free='$pharmfree',issuedfrom='ip' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				}	    	}		}		}				$count=isset($_REQUEST['lab_count'])?$_REQUEST['lab_count']:0;					for($ij=1;$ij<=$count;$ij++){				if(isset($_REQUEST['labcheck'][$ij])){					$lab_auto_number=$_REQUEST['labanum'][$ij];		$lab_code=$_REQUEST['labcode'][$ij];		$lab_name=$_REQUEST['labname'][$ij];		$lab_qty=$_REQUEST['labqty'][$ij];		$lab_rate=$_REQUEST['labrate'][$ij];		$lab_amount=$_REQUEST['labamount'][$ij];		$labfree='No';		$lab_auto=$_REQUEST['labauto'][$ij];		$query13 = "select labtemplate from master_subtype where auto_number = '$subtype' order by subtype";		$exec13 = mysqli_query($GLOBALS["___mysqli_ston"], $query13) or die ("Error in Query13".mysqli_error($GLOBALS["___mysqli_ston"]));		$res13 = mysqli_fetch_array($exec13);		$tablename = $res13['labtemplate'];		if($tablename == ''){		  $tablename = 'master_lab';		}		$query3 = "select rateperunit,pkg from $tablename where itemcode = '$lab_code' and status <> 'deleted'";		$exec3 = mysqli_query($GLOBALS["___mysqli_ston"], $query3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));		if($res3 = mysqli_fetch_array($exec3)){			$lab_rate = $res3["rateperunit"];			$lab_amount=$lab_rate*$lab_qty;			$pkg = $res3["pkg"];			$labfree=($res3["pkg"]=='yes')?"Yes":"No";					}				$labquery1=mysqli_query($GLOBALS["___mysqli_ston"], "insert into ipconsultation_lab(patientcode,patientname,patientvisitcode,labitemcode,labitemname,labitemrate,consultationdate,paymentstatus,labsamplecoll,resultentry,labrefund,iptestdocno,accountname,billtype,consultationtime,freestatus,locationcode,username)values('$patientcode','$patientfullname','$visitcode','$lab_code','$lab_name','$lab_rate','$currentdate','paid','pending','pending','norefund','$billnumbercode','$account','$billtype','$timeonly','$labfree','$locationcode','$username')") or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$lab_insert_id=((is_null($___mysqli_res = mysqli_insert_id($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);		$get_tets++;        		if($mcc_status==1) {				$querylab3 = "select * from consultation_lab where labitemcode = '$lab_code' and patientvisitcode='$op_visitcode' and patientcode='$patientcode' and auto_number='$lab_auto'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update ipconsultation_lab set labsamplecoll='".$reslab3['labsamplecoll']."',resultentry='".$reslab3['resultentry']."',labrefund='".$reslab3['labrefund']."',sampleid='".$reslab3['sampleid']."',docnumber='".$reslab3['docnumber']."',mcc='$mccnum',consultationdate='".$reslab3['consultationdate']."',consultationtime='".$reslab3['consultationtime']."',consultationid='".$reslab3['consultationid']."',locationname='".$reslab3['locationname']."',remarks='".$reslab3['remarks']."' where labitemcode = '$lab_code' and patientvisitcode='$visitcode' and patientcode='$patientcode' and auto_number='$lab_insert_id'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				  				  				}	    	}           mysqli_query($GLOBALS["___mysqli_ston"], "update consultation_lab set paymentstatus='ip admit',labitemrate='0' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);		}				}				$count=isset($_REQUEST['rad_count'])?$_REQUEST['rad_count']:0;					for($ij=1;$ij<=$count;$ij++){				if(isset($_REQUEST['radcheck'][$ij])){				$rad_auto_number=$_REQUEST['radanum'][$ij];		$rad_code=$_REQUEST['radcode'][$ij];		$rad_name=$_REQUEST['radname'][$ij];		$rad_qty=$_REQUEST['radqty'][$ij];		$rad_rate=$_REQUEST['radrate'][$ij];		$rad_amount=$_REQUEST['radamount'][$ij];		$radiologyfree="No";		$rad_auto=$_REQUEST['radauto'][$ij];		$query13r = "select radtemplate from master_subtype where auto_number = '$subtype' order by subtype";		$exec13r = mysqli_query($GLOBALS["___mysqli_ston"], $query13r) or die ("Error in Query13r".mysqli_error($GLOBALS["___mysqli_ston"]));		$res13r = mysqli_fetch_array($exec13r);		$tablename = $res13r['radtemplate'];		if($tablename == ''){		  $tablename = 'master_radiology';		}				$query4 = "select rateperunit,pkg from $tablename where itemcode = '$rad_code' and status <> 'deleted'";		$exec4 = mysqli_query($GLOBALS["___mysqli_ston"], $query4) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));		if($res4 = mysqli_fetch_array($exec4)){			$rad_rate = $res4["rateperunit"];			$rad_amount=$rad_rate*$rad_qty;			$pkg = $res4["pkg"];			$radiologyfree=($res4["pkg"]=='yes')?"Yes":"No";		}				$radiologyquery1=mysqli_query($GLOBALS["___mysqli_ston"], "insert into ipconsultation_radiology(patientcode,patientname,patientvisitcode,radiologyitemcode,radiologyitemname,radiologyitemrate,consultationdate,resultentry,iptestdocno,accountname,billtype,consultationtime,freestatus,locationcode,username)values('$patientcode','$patientfullname','$visitcode','$rad_code','$rad_name','$rad_amount','$currentdate','pending','$billnumbercode','$account','$billtype','$timeonly','$radiologyfree','$locationcode','$username')") or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$rad_insert_id=((is_null($___mysqli_res = mysqli_insert_id($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);		$get_tets++;			if($mcc_status==1) {				$querylab3 = "select * from consultation_radiology where radiologyitemcode = '$rad_code' and patientvisitcode='$op_visitcode' and patientcode='$patientcode' and auto_number='$rad_auto'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update ipconsultation_radiology set resultentry='".$reslab3['resultentry']."',prepstatus='".$reslab3['prepstatus']."',radiologyrefund='".$reslab3['radiologyrefund']."',mcc='$mccnum',docnumber='".$reslab3['docnumber']."',radiologyinstructions='".$reslab3['radiologyinstructions']."',imgaquistatus='".$reslab3['imgaquistatus']."',imagefilename='".$reslab3['imagefilename']."',clinical_diagnosis='".$reslab3['clinical_diagnosis']."',imagefilename2='".$reslab3['imagefilename2']."',imagefilename3='".$reslab3['imagefilename3']."',consultationdate='".$reslab3['consultationdate']."',consultationtime='".$reslab3['consultationtime']."',consultationid='".$reslab3['consultationid']."',locationname='".$reslab3['locationname']."',preparation_datetime='".$reslab3['preparation_datetime']."',aquisition_datetime='".$reslab3['aquisition_datetime']."',reporting_datetime='".$reslab3['reporting_datetime']."' where radiologyitemcode = '$rad_code' and patientvisitcode='$visitcode' and patientcode='$patientcode' and auto_number='$rad_insert_id'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				  				}	    	}           mysqli_query($GLOBALS["___mysqli_ston"], "update consultation_radiology set paymentstatus='ip admit',radiologyitemrate='0' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);         				}				}				$count=isset($_REQUEST['ser_count'])?$_REQUEST['ser_count']:0;			$ser_code='';		for($ij=1;$ij<=$count;$ij++){				if(isset($_REQUEST['sercheck'][$ij])){				$ser_auto_number=$_REQUEST['seranum'][$ij];		$ser_code=$_REQUEST['sercode'][$ij];		$ser_name=$_REQUEST['sername'][$ij];		$ser_qty=$_REQUEST['serqty'][$ij];		$ser_rate=$_REQUEST['serrate'][$ij];		$ser_amount=$_REQUEST['seramount'][$ij];		$ser_auto=$_REQUEST['serauto'][$ij];		$ledgercode='';		$ledgername='';						$servicesfree = "No";		$query5 = "select ledgerid as ledgercode,ledgername from master_services where itemcode = '$ser_code' ";		$exec5 = mysqli_query($GLOBALS["___mysqli_ston"], $query5) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));		if($res5 = mysqli_fetch_array($exec5)){		$ledgercode=$res5["ledgercode"];		$ledgername=$res5["ledgername"];		}		$query13s = "select sertemplate from master_subtype where auto_number = '$subtype' order by subtype";		$exec13s = mysqli_query($GLOBALS["___mysqli_ston"], $query13s) or die ("Error in Query13s".mysqli_error($GLOBALS["___mysqli_ston"]));		$res13s = mysqli_fetch_array($exec13s);		$tablenames = $res13s['sertemplate'];		if($tablenames == ''){		  $tablenames = 'master_services';		}				$query5 = "select rateperunit,pkg from $tablenames where itemcode = '$ser_code' ";		$exec5 = mysqli_query($GLOBALS["___mysqli_ston"], $query5) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));		if($res5 = mysqli_fetch_array($exec5)){			$ser_rate = $res5["rateperunit"];			$ser_amount=$ser_rate*$ser_qty;			$pkg = $res5["pkg"];			$servicesfree=($res5["pkg"]=='yes')?"Yes":"No";		}		$servicesquery1=mysqli_query($GLOBALS["___mysqli_ston"], "insert into ipconsultation_services(patientcode,patientname,patientvisitcode,servicesitemcode,servicesitemname,servicesitemrate,consultationdate,paymentstatus,process,iptestdocno,accountname,billtype,consultationtime,freestatus,locationcode,serviceqty,amount,incomeledgercode,incomeledgername,username,mcc)values('$patientcode','$patientfullname','$visitcode','$ser_code','$ser_name','$ser_code','$currentdate','paid','pending','$billnumbercode','$account','$billtype','$timeonly','$servicesfree','$locationcode','$ser_qty','$ser_amount','$ledgercode','$ledgername','$username','$mccnum')") or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$ser_insert_id=((is_null($___mysqli_res = mysqli_insert_id($GLOBALS["___mysqli_ston"]))) ? false : $___mysqli_res);		$get_tets++;			if($mcc_status==1) {				$querylab3 = "select * from consultation_services where servicesitemcode = '$ser_code' and patientvisitcode='$op_visitcode' and patientcode='$patientcode' and auto_number='$ser_auto'";				$execlab3 = mysqli_query($GLOBALS["___mysqli_ston"], $querylab3) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));				if(mysqli_num_rows($execlab3)>0){				  $reslab3 = mysqli_fetch_array($execlab3);				  mysqli_query($GLOBALS["___mysqli_ston"], "update ipconsultation_services set process='".$reslab3['process']."',consultationdate='".$reslab3['consultationdate']."',consultationtime='".$reslab3['consultationtime']."',consultationid='".$reslab3['consultationid']."',locationname='".$reslab3['locationname']."',docnumber='".$reslab3['docnumber']."',approvalstatus='".$reslab3['approvalstatus']."',billnumber='".$reslab3['billnumber']."' where servicesitemcode = '$ser_code' and patientvisitcode='$visitcode' and patientcode='$patientcode' and auto_number='$ser_insert_id'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				 				}	    	}             mysqli_query($GLOBALS["___mysqli_ston"], "update consultation_services set paymentstatus='ip admit',amount='0' where auto_number='".$reslab3['auto_number']."'") or die(mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				}		}		if($get_tets>0){				mysqli_query($GLOBALS["___mysqli_ston"], "insert into iptest_procedures(docno,patientname,patientcode,visitcode,account,recorddate,ipaddress,recordtime,username,billtype,locationcode)values('$billnumbercode','$patientfullname','$patientcode','$visitcode','$account','$currentdate','$ipaddress','$timeonly','$username','$billtype','$locationcode')") or die(mysqli_error($GLOBALS["___mysqli_ston"]));		}       if($mcc_status==1){		$count=isset($_REQUEST['cons_count'])?$_REQUEST['cons_count']:0;		for($ij=1;$ij<=$count;$ij++){          if(isset($_REQUEST['consultcheck'][$ij])){              			  $query1 = "select * from master_visitentry where patientcode='$patientcode' and visitcode='$op_visitcode'"; 			  $exec1 = mysqli_query($GLOBALS["___mysqli_ston"], $query1) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));			  $num1=mysqli_num_rows($exec1);			  if($num1>0) {				  $res1 = mysqli_fetch_array($exec1);				   $query18 = "select consultation from billing_consultation where patientvisitcode='$op_visitcode' and patientcode='$patientcode'";				   $exec18 = mysqli_query($GLOBALS["___mysqli_ston"], $query18) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				   $res18 = mysqli_fetch_array($exec18);				   				   if($res18['consultation']>0)					 $consulttotamt = $res1['consultationfees'] - $res18['consultation'] ;				   else					 $consulttotamt = $res1['consultationfees'] ;				  $docquery1 = "insert into ipprivate_doctor(consultationdate,consultationtime,patientcode,patientname,patientvisitcode,doctorname,	rate,amount,units,docno,billtype,accountname,locationcode,paymentstatus,username,remarks,doccoa,servicecode,pvt_flg,mcc)values('".$res1['consultationdate']."','".$res1['consultationtime']."','".$res1['patientcode']."','".$res1['patientfullname']."','".$visitcode."','".$res1['consultingdoctor']."','".$consulttotamt."','".$consulttotamt."','1','".$billnumbercode."','".$res1['billtype']."','".$res1['accountfullname']."','".$patientlocationcode."','pending','".$res1['username']."','ip admit','".$res1['consultingdoctorcode']."','".$ser_code."','1','$mccnum')";		          mysqli_query($GLOBALS["___mysqli_ston"], $docquery1) or die("Error in docquery1". mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);				  $query64 = "update master_visitentry set consultationfees='0',planfixedamount='0',planpercentage='0' where patientcode='$patientcode' and visitcode='$op_visitcode' and locationcode='$patientlocationcode'";				  mysqli_query($GLOBALS["___mysqli_ston"], $query64) or die(mysqli_error($GLOBALS["___mysqli_ston"]));			  }		  }		}	   }						}				header("location:admissionlist.php");		exit;}if (isset($_REQUEST["st"])) { $st = $_REQUEST["st"]; } else { $st = ""; }//$st = $_REQUEST['st'];if ($st == '1'){	$errmsg = "Success. Payment Entry Update Completed.";}if ($st == '2'){	$errmsg = "Failed. Payment Entry Not Completed.";}//include ("autocompletebuild_customer1.php");?><?php$query3 = "select * from master_company where companystatus = 'Active'";$exec3 = mysqli_query($GLOBALS["___mysqli_ston"], $query3) or die ("Error in Query3".mysqli_error($GLOBALS["___mysqli_ston"]));$res3 = mysqli_fetch_array($exec3);$paynowbillprefix = 'BA-';$paynowbillprefix1=strlen($paynowbillprefix);$query2 = "select * from ip_bedallocation order by auto_number desc limit 0, 1";$exec2 = mysqli_query($GLOBALS["___mysqli_ston"], $query2) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));$res2 = mysqli_fetch_array($exec2);$billnumber = $res2["docno"];$billdigit=strlen($billnumber);if ($billnumber == ''){	$billnumbercode =$paynowbillprefix.'1';		$openingbalance = '0.00';}else{	$billnumber = $res2["docno"];	$billnumbercode = substr($billnumber,$paynowbillprefix1, $billdigit);	//echo $billnumbercode;	$billnumbercode = intval($billnumbercode);	$billnumbercode = $billnumbercode + 1;	$maxanum = $billnumbercode;			$billnumbercode = $paynowbillprefix .$maxanum;	$openingbalance = '0.00';	//echo $companycode;}?><?phpif(isset($_REQUEST['patientcode'])) { $patientcode = $_REQUEST["patientcode"]; } else { $patientcode = ""; }if(isset($_REQUEST['visitcode'])) { $visitcode = $_REQUEST["visitcode"]; } else { $visitcode = ""; }		$query1 = "select * from master_ipvisitentry where patientcode='$patientcode' and visitcode='$visitcode'"; 		$exec1 = mysqli_query($GLOBALS["___mysqli_ston"], $query1) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));		$num1=mysqli_num_rows($exec1);				$res1 = mysqli_fetch_array($exec1);				$patientlocationcode=$res1['locationcode'];		$patientlocationname=$res1['locationname'];		?><style type="text/css"><!--body {	margin-left: 0px;	margin-top: 0px;	background-color: #ecf0f5;}.bodytext3 {	FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3B3B3C; FONT-FAMILY: Tahoma}--></style><script>function funcwardChange(){	<?php 	$query12 = "select * from master_ward where locationcode='$patientlocationcode' and recordstatus=''";	$exec12 = mysqli_query($GLOBALS["___mysqli_ston"], $query12) or die ("Error in Query11".mysqli_error($GLOBALS["___mysqli_ston"]));	while ($res12 = mysqli_fetch_array($exec12))	{	$res12wardanum = $res12["auto_number"];	$res12ward = $res12["ward"];	?>	if(document.getElementById("ward").value=="<?php echo $res12wardanum; ?>")	{	    document.getElementById("bed").options.length=null; 		var combo = document.getElementById('bed');		<?php 		$loopcount=0;		?>		combo.options[<?php echo $loopcount;?>] = new Option ("Select  Bed", ""); 		<?php		$query10 = "select * from master_bed where ward = '$res12wardanum' and recordstatus = '' and locationcode='$patientlocationcode'";		$exec10 = mysqli_query($GLOBALS["___mysqli_ston"], $query10) or die ("error in query10".mysqli_error($GLOBALS["___mysqli_ston"]));		while ($res10 = mysqli_fetch_array($exec10))		{				$res10bedanum = $res10['auto_number'];		$res10bed = $res10["bed"];				$query21 = "select * from ip_bedallocation where ward='$res12wardanum' and bed='$res10bedanum' and recordstatus='' and locationcode='$patientlocationcode'";		$exec21 = mysqli_query($GLOBALS["___mysqli_ston"], $query21) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		$num21 = mysqli_num_rows($exec21);		if($num21 == 0)		{		$loopcount = $loopcount+1;		?>			combo.options[<?php echo $loopcount;?>] = new Option ("<?php echo strtoupper($res10bed);?>", "<?php echo $res10bedanum;?>"); 		<?php 		}		}		?>	}	<?php	}	?>	}function validcheck(){if(document.getElementById("ward").value == ''){alert("Please Select Ward");document.getElementById("ward").focus();return false;}if(document.getElementById("bed").value == ''){alert("Please Select Bed");document.getElementById("bed").focus();return false;}}function funcstandby(){//alert('h');if(document.getElementById("standbybed").checked == true){<?php 	$query123= "select * from master_bedcharge where bed='Stand By Bed'";	$exec123 = mysqli_query($GLOBALS["___mysqli_ston"], $query123) or die ("Error in Query123".mysqli_error($GLOBALS["___mysqli_ston"]));	$res123 = mysqli_fetch_array($exec123);	$rate = $res123['rate'];	?>	document.getElementById("standbybedrate").value = "<?php echo $rate; ?>";}else{document.getElementById("standbybedrate").value = "0.00";}}</script><link rel="stylesheet" type="text/css" href="css/autosuggest.css" />        <style type="text/css"><!--.bodytext3 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}.bodytext31 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}.bodytext311 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}-->.bal{border-style:none;background:none;text-align:right;}.bali{text-align:right;}</style></head><script src="js/datetimepicker_css.js"></script><script src="js/jquery-1.11.1.min.js"></script><script>$(document).ready(function(e) {$("#checkall").change(function () {    $("input:checkbox").prop('checked', $(this).prop("checked"));});    });</script><body><form name="form1" id="form1" method="post" action="ipallocation.php" onSubmit="return validcheck()">	<table width="101%" border="0" cellspacing="0" cellpadding="2">  <tr>    <td colspan="14" bgcolor="#ecf0f5"><?php include ("includes/alertmessages1.php"); ?></td>  </tr>  <tr>    <td colspan="14" bgcolor="#ecf0f5"><?php include ("includes/title1.php"); ?></td>  </tr>  <tr>    <td colspan="14" bgcolor="#ecf0f5"><?php include ("includes/menu1.php"); ?></td>  </tr>  <tr>    <td colspan="14">&nbsp;</td>  </tr>  <tr>    <td width="2%">&nbsp;</td>       <td colspan="5" valign="top"><table width="116%" border="0" cellspacing="0" cellpadding="0">      	 			<tr>		<td>		<table id="AutoNumber3" style="BORDER-COLLAPSE: collapse"             bordercolor="#666666" cellspacing="0" cellpadding="4" width="1100"             align="left" border="0">          <tbody>             <tr>			  <td width="13%" align="center" valign="center" class="bodytext31"><strong>Doc No</strong></td>			   <td width="19%" align="center" valign="center" class="bodytext31"><input type="text" name="docno" id="docno" value="<?php echo $billnumbercode; ?>" size="10" readonly></td>			   <td width="10%"  align="left" valign="center" class="bodytext31"><strong>Date</strong></td>			   <td width="12%"  align="left" valign="center" class="bodytext31"> 			   <input type="text" name="date" id="date" value="<?php echo $updatedate; ?>" size="10" readonly>                      <strong><span class="bodytext312"> <img src="images2/cal.gif" onClick="javascript:NewCssCal('dateofbirth')" style="cursor:pointer"/> </span></strong>								<td width="10%" align="center" valign="center"  class="bodytext31"><strong>Location</strong></td>              <td width="30%" align="left" valign="center"  ><span class="bodytext31"><strong><?php echo $patientlocationname;?></strong>			  <input type="hidden" name="locationcode" id="locationcode" value="<?php echo $patientlocationcode;?>" >			  <input type="hidden" name="patientlocationname" id="patientlocationname" value="<?php echo $patientlocationname;?>" >              </span></td>			               </td>             </tr>            <tr>              				 <td colspan="2"  align="left" valign="center"                 bgcolor="#ffffff" class="bodytext31"><div align="center"><strong> Patient Name</strong></div></td>           				 <td colspan="2"  align="left" valign="center"                 bgcolor="#ffffff" class="bodytext31"><div align="center"><strong>Patient Code  </strong></div></td>				 <td width="20%"  align="left" valign="center"                 bgcolor="#ffffff" class="bodytext31"><div align="center"><strong>IP Visit  </strong></div></td>				 <td width="26%"  align="left" valign="center"                 bgcolor="#ffffff" class="bodytext31"><div align="center"><strong>Account</strong></div></td>              </tr>           <?php            $colorloopcount ='';				$ipvisit_date=date('Y-m-d');			$query1 = "select * from master_ipvisitentry where patientcode='$patientcode' and visitcode='$visitcode'";		$exec1 = mysqli_query($GLOBALS["___mysqli_ston"], $query1) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));		$num1=mysqli_num_rows($exec1);				while($res1 = mysqli_fetch_array($exec1))		{		$patientname=$res1['patientfullname'];		$patientcode=$res1['patientcode'];		$accountname = $res1['accountname'];		$patientlocation=$res1['locationcode'];		$gender = $res1['gender'];		$age = $res1['age'];		$ipvisit_date= $res1['consultationdate'];		$ipbilltype= $res1['billtype'];						$query67 = "select * from master_accountname where auto_number='$accountname'";		$exec67 = mysqli_query($GLOBALS["___mysqli_ston"], $query67); 		$res67 = mysqli_fetch_array($exec67);		$accname = $res67['accountname'];								$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#ecf0f5"';			}			?>          <tr <?php echo $colorcode; ?>>             			  <td colspan="2"  align="left" valign="center" class="bodytext31">			    <div align="center"><?php echo $patientname; ?></div></td>				<td colspan="2"  align="center" valign="center" class="bodytext31"><?php echo $patientcode; ?></td>				<td  align="center" valign="center" class="bodytext31"><?php echo $visitcode; ?></td>				<td  align="center" valign="center" class="bodytext31"><?php echo $accname; ?></td>				<input type="hidden" name="patientname" id="patientname" value="<?php echo $patientname; ?>">				 				<input type="hidden" name="patientcode" id="patientcode" value="<?php echo $patientcode; ?>">				<input type="hidden" name="visitcode" id="visitcode" value="<?php echo $visitcode; ?>">				<input type="hidden" name="billtype" id="billtype" value="<?php echo $ipbilltype; ?>">							<input type="hidden" name="accname" id="accname" value="<?php echo $accname; ?>">			   </tr>		   <?php 		   } 		  		   ?>                       <tr>             	<td colspan="4" align="left" valign="center" bordercolor="#f3f3f3"                 bgcolor="#ecf0f5" class="bodytext311">&nbsp;</td><td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ecf0f5">&nbsp;</td>                         	<td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ecf0f5">&nbsp;</td>             	</tr>          </tbody>        </table>		</td>		</tr>				</table>		</td>		</tr>	      <tr>        <td>&nbsp;</td>      </tr>            <tr>        <td>&nbsp;</td>      <td width="11%" align="center" valign="center" class="bodytext311">Ward</td>	  <td width="16%" align="left" valign="center" class="bodytext311">	 <select name="ward" id="ward" onChange="return funcwardChange();">                         						  <?php 						  $query78 = "select B.auto_number,B.ward,A.wardcode from nurse_ward as A join master_ward as B on (B.auto_number=A.wardcode) where  A.locationcode='$patientlocationcode' and B.recordstatus='' and A.employeecode='$res1employeename'  order by A.defaultward desc";						  $exec78 = mysqli_query($GLOBALS["___mysqli_ston"], $query78) or die(mysqli_error($GLOBALS["___mysqli_ston"]));						  while($res78 = mysqli_fetch_array($exec78))						  {						  $wardanum = $res78['auto_number'];						  $wardname = $res78['ward'];						    ?>                          <option value="<?php echo $wardanum; ?>"><?php echo $wardname; ?></option>						  <?php						  }                          ?>                        </select></td>      <td width="11%" align="center" valign="center" class="bodytext311">Bed</td>      <td width="11%" align="left" valign="center" class="bodytext311">	   <select name="bed" id="bed" >                            <option value="" >Select Bed</option>							<?php 						  $query78 = "select * from master_bed where locationcode='$patientlocationcode' and recordstatus=''";						  $exec78 = mysqli_query($GLOBALS["___mysqli_ston"], $query78) or die(mysqli_error($GLOBALS["___mysqli_ston"]));						  while($res78 = mysqli_fetch_array($exec78))						  {						  $bedanum = $res78['auto_number'];						  $bedname = $res78["bed"];						  ?>						  <option value="<?php echo $bedanum; ?>"><?php echo strtoupper($bedname); ?></option>						  <?php						  } ?>                          </select>	    </td>      <td width="49%" align="left" valign="center" class="bodytext311">&nbsp;</td>      </tr>	       		<input type="hidden" name="standbybedrate" id="standbybedrate" size="10" align="left"><input type="hidden" name="standbybed" id="standbybed" value="1" onClick="return funcstandby();">     	                  </table>  </table>    <?php  	$op_sno=0;	$colorloopcount=0;	$query_opvisit="select * from master_visitentry where patientcode='$patientcode' and consultationdate='$ipvisit_date' and doctorconsultation='completed' and overallpayment=''";	$exec_opvisit=mysqli_query($GLOBALS["___mysqli_ston"], $query_opvisit) or die(mysqli_error($GLOBALS["___mysqli_ston"]));	if($row_opvisit=mysqli_fetch_array($exec_opvisit)){	$op_visitcode=$row_opvisit['visitcode'];	if($row_opvisit['mcc']!=''){      $is_mcc = 1;	  $mccnum=$row_opvisit['mcc'];	}	else {	  $is_mcc =0;	  $mccnum='';	}	$accountname = $row_opvisit['accountname'];	/*$is_mcc =0;	$query4 = "select * from master_accountname where auto_number = '$accountname'";	$exec4 = mysql_query($query4) or die ("Error in Query4".mysql_error());	$res4 = mysql_fetch_array($exec4);	$is_mcc = $res4['mcc']; */	$query111  = "select subtype from master_customer where customercode = '$patientcode'";	$exec111 = mysqli_query($GLOBALS["___mysqli_ston"], $query111) or die ("Error in Query111".mysqli_error($GLOBALS["___mysqli_ston"]));	$res111 = mysqli_fetch_array($exec111);	$res111subtype = $res111['subtype'];	$query131 = "select subtype from master_subtype where auto_number = '$res111subtype'";	$exec131 = mysqli_query($GLOBALS["___mysqli_ston"], $query131) or die ("Error in Query131".mysqli_error($GLOBALS["___mysqli_ston"]));	$res131 = mysqli_fetch_array($exec131);	$res131subtype = $res131['subtype'];	$accname=$row_opvisit['accountname'];	$plannumber = $row_opvisit['planname'];	$planpercent = $row_opvisit['planpercentage'];	$billtype = $row_opvisit['billtype'];		$showgrid=0;	if($is_mcc==1){		$showgrid=1;	}elseif($billtype=="PAY LATER"){		$queryplanname = "select forall from master_planname where auto_number ='".$plannumber."' ";// and (billingdatetime between '$triagedatefrom' and '$triagedateto')";//		$execplanname = mysqli_query($GLOBALS["___mysqli_ston"], $queryplanname) or die ("Error in Queryplanname".mysqli_error($GLOBALS["___mysqli_ston"]));		$resplanname = mysqli_fetch_array($execplanname);		$planforall = $resplanname['forall'];			if($planforall=='yes' && $planpercent>0.00){			$showgrid=1;			}	}else{		$showgrid=1;	}$showgrid='removed by paka';if($showgrid==1){?>			 <table width="70%" style="margin-left:5%;border-collapse: collapse;" border="0" align="left" cellpadding="2" cellspacing="0" bordercolor="#666666" id="AutoNumber3" >       <tr><td>&nbsp;  </td></tr>	       <tr><td>&nbsp;  </td></tr>		   <tr>       	<td colspan="2" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31" >          <input type="checkbox" id="checkall" /> <label for="checkall">Check All </label>        <input type="hidden" name="subtype" value="<?= $res111subtype ?>" />		<input type="hidden" name="mcc_status" id="mcc_status" value="<?= $is_mcc ?>" />		<input type="hidden" name="mccnum" id="mccnum" value="<?= $mccnum ?>" />		<input type="hidden" name="op_visitcode" id="op_visitcode" value="<?= $op_visitcode ?>" />        </td> 		<td colspan="7" align="center" valign="center" bgcolor="#ecf0f5" class="bodytext31" ><strong> Choose To Post OP Bills To IP Bills</strong> </td>		</tr><?php   if($is_mcc==1){	  $cons_count=0;      $query_oprad = "select * from master_visitentry where visitcode='$op_visitcode' and patientcode='$patientcode' ";      $exec_oppharm=mysqli_query($GLOBALS["___mysqli_ston"], $query_oprad) or die(mysqli_error($GLOBALS["___mysqli_ston"]));  	  $num_oppharm=mysqli_num_rows($exec_oppharm);		  if($num_oppharm>0){       $cons_count = $cons_count+1;	          ?>	   <tr>	       <td colspan="9" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31" > <strong>Consultation </strong></td> </tr>	   <?php	    while($row_oppharm=mysqli_fetch_array($exec_oppharm)){ 		   $query18 = "select consultation from billing_consultation where patientvisitcode='$op_visitcode' and patientcode='$patientcode'";		   $exec18 = mysqli_query($GLOBALS["___mysqli_ston"], $query18) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]).__LINE__);		   $res18 = mysqli_fetch_array($exec18);		   		   if($res18['consultation']>0)		     $consulttotamt = $row_oppharm['consultationfees'] - $res18['consultation'] ;	       else		     $consulttotamt = $row_oppharm['consultationfees'] ;		   ?>	   <tr <?php echo $colorcode; ?>>        <td class="bodytext31">            <input type="checkbox" name="consultcheck[<?= $cons_count ?>]" />        </td>		<td class="bodytext31"><?= ++$op_sno; ?></td>        <td class="bodytext31"><?= $row_oppharm['consultationdate']; ?></td>        <td class="bodytext31"></td>        <td class="bodytext31">Consultation Fee</td>        <td class="bodytext31"></td>        <td class="bodytext31"></td>        <td class="bodytext31"><?= number_format($consulttotamt,2); ?></td>		<td class="bodytext31"></td>		<td></td>       </tr>	  <?php	   }	  }	}?> <input type="hidden" name="cons_count" value="<?= $cons_count ?>" /><?php   if($is_mcc==1){	$query_oppharm = "select * from master_consultationpharm where patientvisitcode='$op_visitcode' and patientcode='$patientcode' GROUP BY medicinecode";    }else{		$query_oppharm = "select * from master_consultationpharm where patientvisitcode='$op_visitcode' and patientcode='$patientcode' and pharmacybill='pending' and medicineissue='pending' and billing='' and approvalstatus !='0' and (amendstatus='1' OR amendstatus=2)";	}	$exec_oppharm=mysqli_query($GLOBALS["___mysqli_ston"], $query_oppharm) or die(mysqli_error($GLOBALS["___mysqli_ston"]));	$num_oppharm=mysqli_num_rows($exec_oppharm);		if($num_oppharm>0){	?>	   <tr>	       <td colspan="9" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31" > <strong>Pharmacy </strong></td> </tr>	<?php	}    $medicine_count=0;	while($row_oppharm=mysqli_fetch_array($exec_oppharm)){		$op_pharmanum = $row_oppharm['auto_number'];		$op_pharmdate = $row_oppharm['recorddate'];		$op_pharmrefno = $row_oppharm['refno'];		$op_pharmcode = $row_oppharm['medicinecode'];		$op_pharmdesc = $row_oppharm['medicinename'];		$op_pharmqty = $row_oppharm['quantity'];		$op_pharmrate = $row_oppharm['rate'];		$op_pharmamount = $row_oppharm['amount'];        $op_return = 1;			if($op_pharmrate=='0.00'){				$query77="select rateperunit from master_medicine where itemname='$op_pharmdesc'";				$exec77=mysqli_query($GLOBALS["___mysqli_ston"], $query77);				$res77=mysqli_fetch_array($exec77);				$op_pharmrate=$res77['rateperunit'];			}				$amendstatus=$row_oppharm['amendstatus'];			if($amendstatus=='2')			{				$op_pharmamount=$op_pharmqty * $op_pharmrate;			}			if($is_mcc==1){				if($amendstatus=='2')				{				    $query_oppharmsub = "select * from pharmacysales_details where itemcode = '$op_pharmcode' and visitcode='$op_visitcode' and patientcode='$patientcode'";					$exec_oppharm1=mysqli_query($GLOBALS["___mysqli_ston"], $query_oppharmsub) or die(mysqli_error($GLOBALS["___mysqli_ston"]));					if($row_oppharm1=mysqli_fetch_array($exec_oppharm1)) {					  $op_pharmqty = (int)$row_oppharm1['quantity'];					  $op_pharmrate = $row_oppharm1['rate'];					  $op_pharmamount=$op_pharmqty * $op_pharmrate;					}				}				$query_oppharmsubreturn = "SELECT * FROM `pharmacysalesreturn_details` where itemcode = '$op_pharmcode' and visitcode='$op_visitcode' and patientcode='$patientcode'";				$oppharmsubreturn=mysqli_query($GLOBALS["___mysqli_ston"], $query_oppharmsubreturn) or die(mysqli_error($GLOBALS["___mysqli_ston"]));                $num_return=mysqli_num_rows($oppharmsubreturn);				if($num_return>0)					$op_return = 0;			}     if($op_return==1){			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#ecf0f5"';			}	$medicine_count++;?>	  <tr <?php echo $colorcode; ?>>        <td class="bodytext31">            <input type="checkbox" name="medicinecheck[<?= $medicine_count ?>]" />        </td>        <td class="bodytext31"><?= ++$op_sno; ?></td>        <td class="bodytext31"><?= $op_pharmdate; ?></td>        <td class="bodytext31"><?= $op_pharmrefno; ?></td>        <td class="bodytext31"><?= $op_pharmdesc; ?></td>        <td class="bodytext31"><?= $op_pharmqty; ?></td>        <td class="bodytext31"><?= number_format($op_pharmrate,2); ?></td>        <td class="bodytext31"><?= number_format($op_pharmamount,2); ?></td>		<td class="bodytext31"><!--<?= $row_oppharm['medicineissue']; ?>-->                <input type="hidden" name="medicineanum[<?= $medicine_count ?>]" value="<?= $op_pharmanum ?>" />        <input type="hidden" name="medicinecode[<?= $medicine_count ?>]" value="<?= $op_pharmcode ?>" />        <input type="hidden" name="medicinename[<?= $medicine_count ?>]" value="<?= $op_pharmdesc ?>" />        <input type="hidden" name="medicinerate[<?= $medicine_count ?>]" value="<?= $op_pharmrate ?>" />        <input type="hidden" name="medicineqty[<?= $medicine_count ?>]" value="<?= $op_pharmqty ?>" />        <input type="hidden" name="medicineamount[<?= $medicine_count ?>]" value="<?= $op_pharmamount ?>" />		<input type="hidden" name="medicineissue[<?= $medicine_count ?>]" value="<?= $row_oppharm['medicineissue'] ?>" />		<input type="hidden" name="medicineauto[<?= $medicine_count ?>]" value="<?= $row_oppharm['auto_number'] ?>" />                </td>		<td></td>		</tr><?php	 }	}?>        <input type="hidden" name="medicine_count" value="<?= $medicine_count ?>" /><?php   if($is_mcc==1){		$query_oplab = "select * from consultation_lab where patientvisitcode='$op_visitcode' and patientcode='$patientcode' and labrefund!='refund' GROUP BY labitemcode";    }else{		$query_oplab = "select * from consultation_lab where patientcode='$patientcode' and patientvisitcode='$op_visitcode' and paymentstatus='pending' and approvalstatus !='0'";	}	$exec_oplab=mysqli_query($GLOBALS["___mysqli_ston"], $query_oplab) or die(mysqli_error($GLOBALS["___mysqli_ston"]));	$num_oplab=mysqli_num_rows($exec_oplab);		if($num_oplab>0){?>   <tr>	<td colspan="9" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31" > <strong>Lab </strong></td> </tr><?php	}$lab_count=0;	while($row_oplab=mysqli_fetch_array($exec_oplab)){				$op_labdate = $row_oplab['consultationdate'];		$op_labanum = $row_oplab['auto_number'];		$op_labcode= $row_oplab['labitemcode'];		$op_labrefno = $row_oplab['refno'];		$op_labdesc = $row_oplab['labitemname'];		$op_labqty = 1;		$op_labrate = $row_oplab['labitemrate'];		$op_labamount = $row_oplab['labitemrate'];			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#ecf0f5"';			}	$lab_count++;?>	  <tr <?php echo $colorcode; ?>>        <td class="bodytext31">            <input type="checkbox" name="labcheck[<?= $lab_count ?>]" />        </td>        <td class="bodytext31"><?= ++$op_sno; ?></td>        <td class="bodytext31"><?= $op_labdate; ?></td>        <td class="bodytext31"><?= $op_labrefno; ?></td>        <td class="bodytext31"><?= $op_labdesc; ?></td>        <td class="bodytext31"><?= $op_labqty; ?></td>        <td class="bodytext31"><?= number_format($op_labrate,2); ?></td>        <td class="bodytext31"><?= number_format($op_labamount,2); ?></td>		<td class="bodytext31"><!--<?= $row_oplab['labsamplecoll']; ?>-->                <input type="hidden" name="labanum[<?= $lab_count ?>]" value="<?= $op_labanum ?>" />        <input type="hidden" name="labcode[<?= $lab_count ?>]" value="<?= $op_labcode ?>" />        <input type="hidden" name="labname[<?= $lab_count ?>]" value="<?= $op_labdesc ?>" />        <input type="hidden" name="labrate[<?= $lab_count ?>]" value="<?= $op_labrate ?>" />        <input type="hidden" name="labqty[<?= $lab_count ?>]" value="<?= $op_labqty ?>" />        <input type="hidden" name="labamount[<?= $lab_count ?>]" value="<?= $op_labamount ?>" />        <input type="hidden" name="labauto[<?= $lab_count ?>]" value="<?= $row_oplab['auto_number'] ?>" />        </td>		</tr><?php	}?>        <input type="hidden" name="lab_count" value="<?= $lab_count ?>" /><?php      if($is_mcc==1){		$query_oprad = "select * from consultation_radiology where patientvisitcode='$op_visitcode' and patientcode='$patientcode' and resultentry!='refund' GROUP BY radiologyitemcode";    }else{		$query_oprad = "select * from consultation_radiology where patientcode='$patientcode' and patientvisitcode='$op_visitcode' and paymentstatus='pending' and approvalstatus !='0'";	}		$exec_oprad=mysqli_query($GLOBALS["___mysqli_ston"], $query_oprad) or die(mysqli_error($GLOBALS["___mysqli_ston"]));	$num_oprad=mysqli_num_rows($exec_oprad);		if($num_oprad>0){?>   <tr>	<td colspan="9" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31"><strong>Radiology</strong></td> </tr><?php	}$rad_count=0;	while($row_oprad=mysqli_fetch_array($exec_oprad)){		$op_radanum = $row_oprad['auto_number'];		$op_radcode= $row_oprad['radiologyitemcode'];		$op_raddate = $row_oprad['consultationdate'];		$op_radrefno = $row_oprad['refno'];		$op_raddesc = $row_oprad['radiologyitemname'];		$op_radqty = 1;		$op_radrate = $row_oprad['radiologyitemrate'];		$op_radamount = $row_oprad['radiologyitemrate'];			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#ecf0f5"';			}$rad_count++;?>	  <tr <?php echo $colorcode; ?>>        <td class="bodytext31">            <input type="checkbox" name="radcheck[<?= $rad_count ?>]" />        </td>        <td class="bodytext31"><?= ++$op_sno; ?></td>        <td class="bodytext31"><?= $op_raddate; ?></td>        <td class="bodytext31"><?= $op_radrefno; ?></td>        <td class="bodytext31"><?= $op_raddesc; ?></td>        <td class="bodytext31"><?= $op_radqty; ?></td>        <td class="bodytext31"><?= number_format($op_radrate,2); ?></td>        <td class="bodytext31"><?= number_format($op_radamount,2); ?></td>		<td class="bodytext31"><!--<?= $row_oprad['resultentry']; ?>-->        <input type="hidden" name="radanum[<?= $rad_count ?>]" value="<?= $op_radanum ?>" />        <input type="hidden" name="radcode[<?= $rad_count ?>]" value="<?= $op_radcode ?>" />        <input type="hidden" name="radname[<?= $rad_count ?>]" value="<?= $op_raddesc ?>" />        <input type="hidden" name="radrate[<?= $rad_count ?>]" value="<?= $op_radrate ?>" />        <input type="hidden" name="radqty[<?= $rad_count ?>]" value="<?= $op_radqty ?>" />        <input type="hidden" name="radamount[<?= $rad_count ?>]" value="<?= $op_radamount ?>" />        <input type="hidden" name="radauto[<?= $rad_count ?>]" value="<?= $row_oprad['auto_number'] ?>" />                </td>		</tr><?php	}?>      <input type="hidden" name="rad_count" value="<?= $rad_count ?>" /><?php    if($is_mcc==1){		$query_opser = "select * from consultation_services where patientvisitcode='$op_visitcode' and patientcode='$patientcode' GROUP BY servicesitemcode";    }else{		$query_opser = "select * from consultation_services where patientcode='$patientcode' and patientvisitcode='$op_visitcode' and paymentstatus='pending' and approvalstatus !='0'";	}		$exec_opser=mysqli_query($GLOBALS["___mysqli_ston"], $query_opser) or die(mysqli_error($GLOBALS["___mysqli_ston"]));	$num_opser=mysqli_num_rows($exec_opser);		if($num_opser>0){?>   <tr>	<td colspan="9" align="left" valign="center" bgcolor="#ecf0f5" class="bodytext31"><strong>Services</strong></td> </tr><?php	}$ser_count=0;	while($row_opser=mysqli_fetch_array($exec_opser)){		$op_seranum = $row_opser['auto_number'];		$op_sercode= $row_opser['servicesitemcode'];		$op_serdate = $row_opser['consultationdate'];		$op_serrefno = $row_opser['refno'];		$op_serdesc = $row_opser['servicesitemname'];		$op_serqty = $row_opser['serviceqty'];		$op_serrate = $row_opser['servicesitemrate'];		$op_seramount = $row_opser['amount'];			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#ecf0f5"';			}if($row_opser['servicerefund'] =='refund' || $row_opser['refundquantity'] > 0){   $op_serqty = $row_opser['serviceqty'] - $row_opser['refundquantity'];   $op_seramount = $op_serqty * $row_opser['servicesitemrate'];}if($op_serqty>0) {$ser_count++;?>	  <tr <?php echo $colorcode; ?>>        <td class="bodytext31">            <input type="checkbox" name="sercheck[<?= $ser_count ?>]" />        </td>        <td class="bodytext31"><?= ++$op_sno; ?></td>        <td class="bodytext31"><?= $op_serdate; ?></td>        <td class="bodytext31"><?= $op_serrefno; ?></td>        <td class="bodytext31"><?= $op_serdesc; ?></td>        <td class="bodytext31"><?= $op_serqty; ?></td>        <td class="bodytext31"><?= number_format($op_serrate,2); ?></td>        <td class="bodytext31"><?= number_format($op_seramount,2); ?>                <input type="hidden" name="seranum[<?= $ser_count ?>]" value="<?= $op_seranum ?>" />        <input type="hidden" name="sercode[<?= $ser_count ?>]" value="<?= $op_sercode ?>" />        <input type="hidden" name="sername[<?= $ser_count ?>]" value="<?= $op_serdesc ?>" />        <input type="hidden" name="serrate[<?= $ser_count ?>]" value="<?= $op_serrate ?>" />        <input type="hidden" name="serqty[<?= $ser_count ?>]" value="<?= $op_serqty ?>" />        <input type="hidden" name="seramount[<?= $ser_count ?>]" value="<?= $op_seramount ?>" />        <input type="hidden" name="serauto[<?= $ser_count ?>]" value="<?= $row_opser['auto_number'] ?>" />        </td>		<td></td>		</tr><?php   }}?>      <input type="hidden" name="ser_count" value="<?= $ser_count ?>" /> </table>--><?php }} ?> <table align='center' width='100%'> <tr><td>&nbsp;  </td></tr>	 <tr>        <td>&nbsp;</td>		 <td>&nbsp;</td>		  <td>&nbsp;</td>		<td>&nbsp;</td>		<td>&nbsp;</td>		<td align="center" valign="center" class="bodytext311">         <input type="hidden" name="frmflag1" value="frmflag1" />         <input type="submit" name="Submit" value="Submit" style="border: 1px solid #001E6A" /></td>                       </tr> </table></form><?php include ("includes/footer1.php"); ?><br><br><br><script>funcwardChange();</script></body></html>