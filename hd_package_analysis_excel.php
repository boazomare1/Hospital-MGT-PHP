<?phpsession_start();include ("includes/loginverify.php");include ("db/db_connect.php");header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="package_analysis.xls"');header('Cache-Control: max-age=80'); $ipaddress = $_SERVER['REMOTE_ADDR'];$updatedatetime = date('Y-m-d');$username = $_SESSION['username'];$docno = $_SESSION['docno'];$companyanum = $_SESSION['companyanum'];$companyname = $_SESSION['companyname'];$transactiondatefrom = date('Y-m-d', strtotime('-1 month'));$transactiondateto = date('Y-m-d');$location =isset( $_REQUEST['location'])?$_REQUEST['location']:'';	$errmsg = "";$banum = "1";$supplieranum = "";$custid = "";$custname = "";$balanceamount = "0.00";$openingbalance = "0.00";$searchsuppliername = "";$cbsuppliername = "";//This include updatation takes too long to load for hunge items database.	$colorloopcount=0;	$sno=0;if (isset($_REQUEST["cbfrmflag1"])) { $cbfrmflag1 = $_REQUEST["cbfrmflag1"]; } else { $cbfrmflag1 = ""; }//$cbfrmflag1 = $_REQUEST['cbfrmflag1'];if ($cbfrmflag1 == 'cbfrmflag1'){	if(isset($_REQUEST['location'])){$_REQUEST['location'] = $_REQUEST['location'];}	$searchlocationcode = $_REQUEST['location'];	if(isset($_REQUEST['patient'])){$_SESSION['ippatient'] = $_REQUEST['patient'];}	$searchpatient = $_SESSION['ippatient'];	if(isset($_REQUEST['patientcode'])){$_SESSION['ippatientcode'] = $_REQUEST['patientcode'];}	$searchpatientcode=$_SESSION['ippatientcode'];	if(isset($_REQUEST['visitcode'])){$_SESSION['ipvisitcode'] = $_REQUEST['visitcode'];}	$searchvisitcode = $_SESSION['ipvisitcode'];	if(isset($_REQUEST['ADate1'])){$_SESSION['ipADate1'] = $_REQUEST['ADate1'];}	$fromdate=$_SESSION['ipADate1'];	if(isset($_REQUEST['ADate2'])){$_SESSION['ipADate2'] = $_REQUEST['ADate2'];}	$todate=$_SESSION['ipADate2'];?>	<table id="AutoNumber3" style="BORDER-COLLAPSE: collapse" bordercolor="#666666" cellspacing="0" cellpadding="4" width="1300" align="left" border="0">          <tbody>		              <tr>				<td colspan="16"  bgcolor="#CCCCCC" class="bodytext31"><b>Package Details From <?php echo $fromdate; ?> and <?php echo $todate; ?></b></td>							 </tr>           <tr>                <td class="bodytext31" valign="center"  align="left"                 bgcolor="#ffffff"><strong>No.</strong></td>				<td align="left" valign="center"                  bgcolor="#ffffff" class="bodytext31"><strong>Location</strong></td>                <td align="left" valign="center"                  bgcolor="#ffffff" class="bodytext31"><strong>Reg Code</strong></td>				  <td align="left" valign="center"                  bgcolor="#ffffff" class="bodytext31"><strong>Visit No</strong></td>					  <td align="left" valign="center"                  bgcolor="#ffffff" class="bodytext31"><strong>Visit Date</strong></td>							        <td class="bodytext31" valign="center"  align="left"                 bgcolor="#ffffff"><div align="left"><strong>Patient Name </strong></div></td>	  <td class="bodytext31" align="left" valign="center" bgcolor="#ffffff"><strong>Age</strong></td>	  <td  align="left" valign="center" bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Gender</strong></div></td>	  <td  align="left" valign="center" bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Account Name</strong></div></td>	  <td class="bodytext31" valign="center"  align="left"bgcolor="#ffffff"><div align="left"><strong>IP Bill No</strong> </div></td>	  <td class="bodytext31" valign="center"  align="left"bgcolor="#ffffff"><div align="left"><strong>Pre-Auth</strong> </div></td>	  <td class="bodytext31" valign="center"  align="left"bgcolor="#ffffff"><div align="left"><strong>Package Name</strong> </div></td>	  <td align="left" valign="center" bgcolor="#ffffff" class="bodytext31"><strong>Package Value</strong></td>	   <td class="bodytext31" valign="center"  align="left"bgcolor="#ffffff"><div align="left"><strong>Total Consumption</strong> </div></td>	  <td class="bodytext31" valign="center"  align="left"bgcolor="#ffffff"><div align="left"><strong>Net Gain/Loss</strong> </div></td>	   </tr>			  <?php if($searchlocationcode!=""){            $query2 = "select * from master_ipvisitentry where  locationcode='$searchlocationcode'  and patientfullname like '%$searchpatient%' and patientcode like '%$searchpatientcode%' and visitcode like '%$searchvisitcode%'  and consultationdate between '$fromdate' and '$todate' and finalbillno!='' and package!='0' order by auto_number desc";}else{$query2 = "select * from master_ipvisitentry where   patientfullname like '%$searchpatient%' and patientcode like '%$searchpatientcode%' and visitcode like '%$searchvisitcode%'  and consultationdate between '$fromdate' and '$todate' and finalbillno!='' and package!='0' order by auto_number desc";	}			  $exec2 = mysqli_query($GLOBALS["___mysqli_ston"], $query2) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));			  $num2 = mysqli_num_rows($exec2);			 // echo $num2;			  while ($res2 = mysqli_fetch_array($exec2))			  {			  $res2customercode = $res2['patientcode'];			  $res2visitcode = $res2['visitcode'];			  $res2customeranum = $res2['auto_number'];			  $res2customername = $res2['patientfullname'];			  $res2customercode = $res2['patientcode'];			  $consultationdate = $res2['consultationdate'];			  $paymentstatus = $res2['paymentstatus'];				$totalamount = $res2['packagecharge'];				$package = $res2['package'];			  $username=$res2['username'];			  $query_pack = "select * from master_ippackage where  auto_number='$package'";			  $exec_pack = mysqli_query($GLOBALS["___mysqli_ston"], $query_pack) or die(mysqli_error($GLOBALS["___mysqli_ston"]));			  $res_pack = mysqli_fetch_array($exec_pack);			  $packagename = $res_pack['packagename'];			  $query34 = "select * from master_customer where  customercode='$res2customercode'";			  $exec34 = mysqli_query($GLOBALS["___mysqli_ston"], $query34) or die(mysqli_error($GLOBALS["___mysqli_ston"]));			  $res34 = mysqli_fetch_array($exec34);			  $res2age = $res34['age'];			  $res2gender = $res34['gender'];			  $res2nationalidnumber = $res34['nationalidnumber'];			  //$res2contactperson1 = $res2['contactperson1'];			  $paymenttypeanum = $res2['paymenttype'];			  $locationcode2 = $res2['locationcode'];			  			  $query3 = "select * from master_paymenttype where auto_number = '$paymenttypeanum'";			  $exec3 = mysqli_query($GLOBALS["___mysqli_ston"], $query3) or die ("Error in Query5".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res3 = mysqli_fetch_array($exec3);			  $res3paymenttype = $res3['paymenttype'];			  			  $subtypeanum = $res2['subtype'];			  			  $query4 = "select * from master_subtype where  auto_number = '$subtypeanum'";			  $exec4 = mysqli_query($GLOBALS["___mysqli_ston"], $query4) or die ("Error in Query5".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res4 = mysqli_fetch_array($exec4);			  $res4subtype = $res4['subtype'];			  $res2billtype = $res2['billtype'];			  $accountnameanum = $res2['accountname'];	          $query5 = "select * from master_accountname where   auto_number = '$accountnameanum'";			  $exec5 = mysqli_query($GLOBALS["___mysqli_ston"], $query5) or die ("Error in Query5".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res5 = mysqli_fetch_array($exec5);			  $res5accountname = $res5['accountname'];			  $res2accountexpirydate = $res2['accountexpirydate'];			  $plannameanum = $res2['planname'];			  $query6 = "select * from master_planname where  locationcode='$searchlocationcode'  and auto_number = '$plannameanum'";			  $exec6 = mysqli_query($GLOBALS["___mysqli_ston"], $query6) or die ("Error in Query6".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res6 = mysqli_fetch_array($exec6);			  $res6planname = $res6['planname'];			  			    $res2consultingdoctor = $res2['consultingdoctor'];			    $bedallocation = $res2['bedallocation'];				$allo_status=" Not Allocated";				if($bedallocation=='completed')				{					$allo_status="Allocated";				}			 			  $res3ipnumber = '';			  			  $colorloopcount = $colorloopcount + 1;			  $showcolor = ($colorloopcount & 1); 			  $colorcode = '';				if ($showcolor == 0)				{					//echo "if";					$colorcode = 'bgcolor="#CBDBFA"';				}				else				{					//echo "else";					$colorcode = 'bgcolor="#5fe5de"';				}				if($paymentstatus=='')				{					$paymentstatus='Not Completed';				}								$query12 = "select locationname from master_location where locationcode='$locationcode2' order by locationname";						$exec12 = mysqli_query($GLOBALS["___mysqli_ston"], $query12) or die ("Error in Query12".mysqli_error($GLOBALS["___mysqli_ston"]));						$res12 = mysqli_fetch_array($exec12);						$res1location = $res12["locationname"];												$conpkgamt=0;						$query121 = "select sum(amount) as allseramt from package_processing where visitcode = '$res2visitcode' and package_item_type!='MI' and recordstatus='completed'";			$exec121= mysqli_query($GLOBALS["___mysqli_ston"], $query121) or die ("Error in Query121".mysqli_error($GLOBALS["___mysqli_ston"]));			$res121 = mysqli_fetch_array($exec121);			$res121allseramt = $res121["allseramt"];			$conpkgamt+=$res121allseramt;										$query_v = "select SUM(totalcp) as totalprc from pharmacysales_details where  patientcode='$res2customercode'  and visitcode = '$res2visitcode'";			  $exec_V = mysqli_query($GLOBALS["___mysqli_ston"], $query_v) or die ("Error in query_v".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res_v = mysqli_fetch_array($exec_V);			  $prc_value = $res_v['totalprc'];				$conpkgamt+=$prc_value;						  			  $query_b = "select billno,preauthcode from billing_ip where  patientcode='$res2customercode'  and visitcode = '$res2visitcode'			   UNION ALL select billno,preauthcode from billing_ipcreditapproved where  patientcode='$res2customercode'  and visitcode = '$res2visitcode'";			  $exec_b = mysqli_query($GLOBALS["___mysqli_ston"], $query_b) or die ("Error in query_b".mysqli_error($GLOBALS["___mysqli_ston"]));			  $res_b = mysqli_fetch_array($exec_b);			  $billno = $res_b['billno'];			 			  $preauthcode = $res_b['preauthcode'];			  $gain_loss=$totalamount-$conpkgamt;			  ?>              <tr >                <td class="bodytext31" valign="center"  align="left"><?php echo $colorloopcount; ?></td>				<td  align="left" valign="center" class="bodytext31"><div class="bodytext31"><div align="left"><span class="bodytext32"><?php echo $res1location; ?></span></div>				</div></td><td  align="left" valign="center" class="bodytext31"><div class="bodytext31">                    <div align="left"><span class="bodytext32"><?php echo $res2customercode; ?></span></div>                </div></td>				  <td  align="left" valign="center" class="bodytext31"><div class="bodytext31">                    <div align="left"><span class="bodytext32"><?php echo $res2visitcode; ?></span></div>                </div></td>				   <td  align="left" valign="center" class="bodytext31"><div class="bodytext31"> <div align="left"><span class="bodytext32"><?php echo $consultationdate; ?></span></div></div></td>                   <td class="bodytext31" valign="center"  align="left"><div align="left"><?php echo $res2customername; ?></div></td>										<td class="bodytext31" valign="center"  align="left"><div align="left"><?php echo $res2age; ?></div></td>					<td  align="left" valign="center" class="bodytext31"><div align="left"><?php echo $res2gender; ?></div></td>					<td  align="left" valign="center" class="bodytext31"><div align="left"> <?php echo $res5accountname; ?></div></td>										<td class="bodytext31" valign="center"  align="left"><?php echo $billno; ?></td>                    <td class="bodytext31" valign="center"  align="left"><?php echo $preauthcode; ?></td>                    <td class="bodytext31" valign="center"  align="left"><?php echo $packagename; ?></td>					<td  align="left" valign="center" class="bodytext31"><div class="bodytext31"><div align="left"><span class="bodytext32"><?php echo number_format($totalamount,2); ?></span></div></div></td>					<td  align="left" valign="center" class="bodytext31"><div class="bodytext31"><div align="left"><span class="bodytext32"><?php echo number_format($conpkgamt,2); ?></span></div></div></td>					<td  align="left" valign="center" class="bodytext31"><div class="bodytext31"><div align="left"><span class="bodytext32"><?php echo number_format($gain_loss,2); ?></span></div></div></td>					                    </tr>			  <?php			  }  ?>          </tbody>        </table><?php}?>	