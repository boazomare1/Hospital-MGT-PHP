<?phpob_start();session_start();include ("includes/loginverify.php");include ("db/db_connect.php");$ipaddress = $_SERVER['REMOTE_ADDR'];$updatedatetime = date('Y-m-d');$username = $_SESSION['username'];$companyanum = $_SESSION['companyanum'];$companyname = $_SESSION['companyname'];$transactiondatefrom = date('Y-m-d', strtotime('-1 month'));$transactiondateto = date('Y-m-d');$dateonly = date("Y-m-d");$timeonly = date("H:i:s");$datetimeonly = date("Y-m-d H:i:s");$query23 = "select * from master_employee where username='$username'";$exec23 = mysqli_query($GLOBALS["___mysqli_ston"], $query23) or die(mysqli_error($GLOBALS["___mysqli_ston"]));$res23 = mysqli_fetch_array($exec23);$res7locationanum = $res23['location'];$query55 = "select * from master_location where auto_number='$res7locationanum'";$exec55 = mysqli_query($GLOBALS["___mysqli_ston"], $query55) or die(mysqli_error($GLOBALS["___mysqli_ston"]));$res55 = mysqli_fetch_array($exec55);$location = $res55['locationname'];$errmsg = "";$banum = "1";$supplieranum = "";$custid = "";$custname = "";$balanceamount = "0.00";$openingbalance = "0.00";$searchsuppliername = "";$cbsuppliername = "";$docno = $_SESSION['docno'];$query = "select * from login_locationdetails where username='$username' and docno='$docno' order by locationname";$exec = mysqli_query($GLOBALS["___mysqli_ston"], $query) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));$res = mysqli_fetch_array($exec);		 $locationname  = $res["locationname"];	 $locationcode = $res["locationcode"];	 $res12locationanum = $res["auto_number"];	   //$locationcode=isset($_REQUEST['location'])?$_REQUEST['location']:'';  if($locationcode!='')  {  $query4 = "select locationname,locationcode from master_location where locationcode = '$locationcode'";	$exec4 = mysqli_query($GLOBALS["___mysqli_ston"], $query4) or die ("Error in Query4".mysqli_error($GLOBALS["___mysqli_ston"]));	$res4 = mysqli_fetch_array($exec4);	  $locationnameget = $res4['locationname'];	  $locationcodeget = $res4['locationcode'];  }   $location=isset($_REQUEST['location'])?$_REQUEST['location']:'';   $storecode=isset($_REQUEST['store'])?$_REQUEST['store']:'';   $searchdocno=isset($_REQUEST['searchdocno'])?$_REQUEST['searchdocno']:'';//This include updatation takes too long to load for hunge items database.if (isset($_REQUEST["canum"])) { $getcanum = $_REQUEST["canum"]; } else { $getcanum = ""; }//$getcanum = $_GET['canum'];if ($getcanum != ''){	$query4 = "select * from master_supplier where auto_number = '$getcanum'";	$exec4 = mysqli_query($GLOBALS["___mysqli_ston"], $query4) or die ("Error in Query4".mysqli_error($GLOBALS["___mysqli_ston"]));	$res4 = mysqli_fetch_array($exec4);	$cbsuppliername = $res4['suppliername'];	$suppliername = $res4['suppliername'];}if (isset($_REQUEST["cbfrmflag1"])) { $cbfrmflag1 = $_REQUEST["cbfrmflag1"]; } else { $cbfrmflag1 = ""; }//$cbfrmflag1 = $_POST['cbfrmflag1'];if ($cbfrmflag1 == 'cbfrmflag1'){}if (isset($_REQUEST["cbfrmflag2"])) { $cbfrmflag2 = $_REQUEST["cbfrmflag2"]; } else { $cbfrmflag2 = ""; }//$cbfrmflag2 = $_REQUEST['cbfrmflag2'];if (isset($_REQUEST["frmflag2"])) { $frmflag2 = $_REQUEST["frmflag2"]; } else { $frmflag2 = ""; }//$frmflag2 = $_POST['frmflag2'];if ($frmflag2 == 'frmflag2'){    $remarks=$_REQUEST['remarks'];	$store=$_REQUEST['storecode'];	$adjustmentdate=date('Y-m-d');	$searchdocno = $_REQUEST['searchdocno'];		$paynowbillprefix = 'ADJ-';	$paynowbillprefix1=strlen($paynowbillprefix);	$query2 = "select * from master_stock where transactionmodule = 'ADJUSTMENT' order by auto_number desc limit 0, 1";	$exec2 = mysqli_query($GLOBALS["___mysqli_ston"], $query2) or die ("Error in Query2".mysqli_error($GLOBALS["___mysqli_ston"]));	$res2 = mysqli_fetch_array($exec2);	$billnumber = $res2["billnumber"];	$billdigit=strlen($billnumber);	if ($billnumber == '')	{		$billnumbercode ='ADJ-'.'1';		$openingbalance = '0.00';	}	else	{		$billnumber = $res2["billnumber"];		$billnumbercode = substr($billnumber,$paynowbillprefix1, $billdigit);		//echo $billnumbercode;		$billnumbercode = intval($billnumbercode);		$billnumbercode = $billnumbercode + 1;		$maxanum = $billnumbercode;						$billnumbercode = 'ADJ-'.$maxanum;		$openingbalance = '0.00';		//echo $companycode;	} 	$locationcodenew=isset($_REQUEST['locationcodenew'])?$_REQUEST['locationcodenew']:'';	$query31 = "select locationname from master_location where locationcode = '$locationcodenew'"; 	$exec31 = mysqli_query($GLOBALS["___mysqli_ston"], $query31) or die ("Error in Query31".mysqli_error($GLOBALS["___mysqli_ston"]));	$res31 = mysqli_fetch_array($exec31);	$locationnamenew = $res31['locationname'];		$serialno = $_REQUEST['serialno'];						for($i=1;$i<=$serialno;$i++)			{				if(isset($_REQUEST['chk'.$i]))				{					$chk = $_REQUEST['chk'.$i];																		$itemname=$_REQUEST['itemname'.$i];			$itemcode=$_REQUEST['itemcode'.$i];			$batchnumber=$_POST['batch'.$i];			$addstock=$_POST['addstock'.$i];			$minusstock=$_POST['minusstock'.$i];			$fifo_code=$_POST['fifo_code'.$i];			$anum=$_POST['autonumber'.$i];			$itemrate=$_POST['itemrate'.$i];			$physicalquantity = $_POST['physicalquantity'.$i];			$systemcurrentstock = $_POST['systemcurrentstock'.$i];			$variance = $_POST['variance'.$i];    if($chk != '' && $_REQUEST['variance'.$i]!=0)					{	$query40 = "select * from master_itempharmacy where itemcode = '$itemcode'";	$exec40 = mysqli_query($GLOBALS["___mysqli_ston"], $query40) or die ("Error in Query40".mysqli_error($GLOBALS["___mysqli_ston"]));	$res40 = mysqli_fetch_array($exec40);	//$itemmrp = $res40['rateperunit'];	$categoryname = $res40['categoryname'];	$query41 = "select rate  from transaction_stock where batch_stockstatus='1' and batchnumber='$batchnumber' and itemcode='$itemcode' and locationcode='$locationcodenew' and storecode='$store' and fifo_code='$fifo_code' limit 0,1";		$exec41 = mysqli_query($GLOBALS["___mysqli_ston"], $query41) or die ("Error in Query41".mysqli_error($GLOBALS["___mysqli_ston"]));	$res41 = mysqli_fetch_array($exec41);	//$itemmrp = $res41['rate'];	$itemmrp = $itemrate;					//$itemsubtotal = $itemmrp * $addstock;		if($addstock != '')	{	$itemsubtotal = $itemmrp * $addstock;	$stockaction=$_REQUEST["stockaction".$i];		if($stockaction=='1')	{		$description='Stock Adj Minus Stock';	}	else if($stockaction=='2')	{		$description='Stock Damaged Minus Stock';	}	else if($stockaction=='3')	{		$description='Stock Expired Minus Stock';	}			//ADD STOCK			$querybatstock2 = "select batch_quantity from transaction_stock where batch_stockstatus='1' and itemcode='$itemcode' and locationcode='$locationcodenew' and fifo_code='$fifo_code' and storecode ='$store'";		$execbatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $querybatstock2) or die ("Error in batQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));		$resbatstock2 = mysqli_fetch_array($execbatstock2);		$bat_quantity = $resbatstock2["batch_quantity"];		$bat_quantity = $bat_quantity+$addstock;		if($bat_quantity<='0'){ $batch_stockstatus='0'; }else{$batch_stockstatus='1';}				$querycumstock2 = "select cum_quantity from transaction_stock where cum_stockstatus='1' and itemcode='$itemcode' and locationcode='$locationcodenew'";		$execcumstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $querycumstock2) or die ("Error in CumQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));		$rescumstock2 = mysqli_fetch_array($execcumstock2);		$cum_quantity = $rescumstock2["cum_quantity"];		$cum_quantity = $cum_quantity+$addstock;		if($cum_quantity<='0'){ $cum_stockstatus='0'; }else{$cum_stockstatus='1';}		//if($cum_quantity >='0')		//{		if($bat_quantity>='0')		{		$queryupdatebatstock2 = "update transaction_stock set cum_stockstatus='0' ,batch_stockstatus='0' where itemcode='$itemcode' and locationcode='$locationcodenew' and storecode='$store' and fifo_code='$fifo_code'";		$execupdatebatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $queryupdatebatstock2) or die ("Error in updatebatQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));				$queryupdatebatstock2 = "update transaction_stock set cum_stockstatus='0' where itemcode='$itemcode' and locationcode='$locationcodenew'";		$execupdatebatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $queryupdatebatstock2) or die ("Error in updatebatQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));					$stockquery2="INSERT INTO transaction_stock (fifo_code, tablename, itemcode, itemname, transaction_date, transactionfunction, description, batchnumber, batch_quantity, transaction_quantity, cum_quantity, entrydocno, docstatus, cum_stockstatus, batch_stockstatus, locationcode, locationname, storecode, storename, username, ipaddress, recorddate, recordtime, updatetime, rate, totalprice) VALUES ('$fifo_code', 'master_stock', '$itemcode', '$itemname', '$dateonly', '1', 'Stock Adj Add Stock', '$batchnumber', '$bat_quantity', '$addstock', '$cum_quantity', '$billnumbercode', '', '$cum_stockstatus', '$batch_stockstatus', '$locationcodenew', '', '$store', '', '$username', '$ipaddress', '$dateonly', '$timeonly', '$datetimeonly', '$itemmrp', '$itemsubtotal')";		//echo '<br>valid qty add#'.$itemname.'--'.$itemcode.'--'.$stockquery2.'<br>';		$stockexecquery2=mysqli_query($GLOBALS["___mysqli_ston"], $stockquery2) or die(mysqli_error($GLOBALS["___mysqli_ston"]));				$query65="INSERT INTO master_stock (itemcode, itemname, transactiondate, transactionmodule, transactionparticular, billnumber, quantity, remarks, username, ipaddress, rateperunit, totalrate, companyanum, companyname, batchnumber, location,store, categoryname, locationname, locationcode, fifo_code, description,doc_number,physical_quantity,system_current_stock,variance) VALUES ('$itemcode', '$itemname', '$adjustmentdate', 'ADJUSTMENT', 'BY ADJUSTMENT ADD',  '$billnumbercode', '$addstock', '$remarks', '$username', '$ipaddress', '$itemmrp', '$itemsubtotal', '$companyanum', '$companyname','$batchnumber','$location','$store','$categoryname','".$locationnamenew."','".$locationcodenew."','$fifo_code','$description','$searchdocno','$physicalquantity','$systemcurrentstock','$variance')";		$exec65=mysqli_query($GLOBALS["___mysqli_ston"], $query65) or die(mysqli_error($GLOBALS["___mysqli_ston"]));							}		//}		// new code starts		// check if the item exists in the store 		$querybatstock2 = "select auto_number from transaction_stock where batch_stockstatus='1' and itemcode='$itemcode' and locationcode='$locationcodenew' and batchnumber = '$batchnumber' and fifo_code='$fifo_code' and storecode ='$store'";		//echo $querybatstock2.'<br>';		$execbatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $querybatstock2) or die ("Error in batQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));		$item_num_rows = mysqli_num_rows($execbatstock2);		if(!$item_num_rows)		{			// item does not exists in the store			/*$queryupdatecumstock2 = "update transaction_stock set cum_stockstatus='0' where itemcode='$itemcode' and locationcode='$locationcodenew' and storecode='$store'";				$execupdatecumstock2 = mysql_query($queryupdatecumstock2) or die ("Error in updateCumQuery2".mysql_error());*/			$itemrate=$_POST['itemrate'.$i];			$itemtot = $itemrate * $addstock;			$stockquery22="INSERT INTO transaction_stock (fifo_code, tablename, itemcode, itemname, transaction_date, transactionfunction, description, batchnumber, batch_quantity, transaction_quantity, cum_quantity, entrydocno, docstatus, cum_stockstatus, batch_stockstatus, locationcode, locationname, storecode, storename, username, ipaddress, recorddate, recordtime, updatetime, rate, totalprice) VALUES ('$fifo_code', 'master_stock', '$itemcode', '$itemname', '$dateonly', '1', 'Stock Adj Add Stock', '$batchnumber', '$addstock', '$addstock', '$addstock', '$billnumbercode', '', '1', '1', '$locationcodenew', '', '$store', '', '$username', '$ipaddress', '$dateonly', '$timeonly', '$datetimeonly', '$itemrate', '$itemtot')";			//echo $stockquery22.'<br>';			//echo '<br>zero qty add #'.$itemname.'--'.$itemcode.'--'.$stockquery22.'<br>';			$stockexecquery22=mysqli_query($GLOBALS["___mysqli_ston"], $stockquery22) or die(mysqli_error($GLOBALS["___mysqli_ston"]));			$query65="INSERT INTO master_stock (itemcode, itemname, transactiondate, transactionmodule, transactionparticular, billnumber, quantity, remarks, username, ipaddress, rateperunit, totalrate, companyanum, companyname, batchnumber, location,store, categoryname, locationname, locationcode, fifo_code, description,doc_number,physical_quantity,system_current_stock,variance) VALUES ('$itemcode', '$itemname', '$adjustmentdate', 'ADJUSTMENT', 'BY ADJUSTMENT ADD',  '$billnumbercode', '$addstock', '$remarks', '$username', '$ipaddress', '$itemmrp', '$itemsubtotal', '$companyanum', '$companyname','$batchnumber','$location','$store','$categoryname','".$locationnamenew."','".$locationcodenew."','$fifo_code','$description','$searchdocno','$physicalquantity','$systemcurrentstock','$variance')";		    $exec65=mysqli_query($GLOBALS["___mysqli_ston"], $query65) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		}			       	    // new code ends		}		else if($minusstock != '')		{						$itemsubtotal = $itemmrp * $minusstock;		$stockaction=$_REQUEST["stockaction".$i];				if($stockaction=='1')		{			$description='Stock Adj Minus Stock';		}		else if($stockaction=='2')		{			$description='Stock Damaged Minus Stock';		}		else if($stockaction=='3')		{			$description='Stock Expired Minus Stock';		}				//MINUS STOCK		$updaterow = $minusstock;/*		$querygetrows = "select * from transaction_stock where itemcode = '$itemcode' and batch_stockstatus = '1' and storecode = '$store' and locationcode = '$locationcodenew' and batchnumber = '$batchnumber' and fifo_code in (select fifo_code from stocktaking where itemcode = '$itemcode' and storecode='$store' and locationcode='$locationcodenew')";//this is previous code for minus stock with check of batchstock_status$querygetrows = "select * from transaction_stock where itemcode = '$itemcode' and batch_stockstatus = '1' and storecode = '$store' and locationcode = '$locationcodenew' and batchnumber = '$batchnumber'";*/		$querygetrows = "select * from transaction_stock where itemcode = '$itemcode' and  storecode = '$store' and locationcode = '$locationcodenew' and batchnumber = '$batchnumber' order by auto_number desc limit 0, 1";		$execgetrows = mysqli_query($GLOBALS["___mysqli_ston"], $querygetrows) or die("Error in querygetrows".mysqli_error($GLOBALS["___mysqli_ston"]));		$numgetrows = mysqli_num_rows($execgetrows);		while($resgetrows = mysqli_fetch_array($execgetrows)){			$auto_number = $resgetrows['auto_number'];			$fifo_code = $resgetrows['fifo_code'];			$batchnumber = $resgetrows['batchnumber'];			$batch_quantity = $resgetrows['batch_quantity'];			$transaction_quantity = $resgetrows['transaction_quantity'];			$cum_quantity = $resgetrows['cum_quantity'];						if($batch_quantity <= $updaterow){				$tquantity = $batch_quantity;				$batch_quantity = 0;				$cum_quantity = $cum_quantity-$tquantity;				$batch_stockstatus = 0;			} else {				$tquantity = $updaterow;				$batch_quantity = $batch_quantity - $tquantity;				$cum_quantity = $cum_quantity-$tquantity;				$batch_stockstatus = 1;			}			if($tquantity==0){break;}			$queryupdatebatstock2 = "update transaction_stock set cum_stockstatus='0', batch_stockstatus='0' where itemcode='$itemcode' and locationcode='$locationcodenew' and storecode='$store' and fifo_code='$fifo_code' and auto_number = '$auto_number'";			$execupdatebatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $queryupdatebatstock2) or die ("Error in updatebatQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));			$stockquery2="INSERT INTO transaction_stock (fifo_code,tablename,itemcode, itemname, transaction_date,transactionfunction,description, batchnumber, batch_quantity, transaction_quantity, cum_quantity, entrydocno, docstatus, cum_stockstatus, batch_stockstatus, locationcode, locationname, storecode, storename, username, ipaddress, recorddate, recordtime, updatetime, rate, totalprice) VALUES ('$fifo_code','master_stock','$itemcode', '$itemname', '$dateonly', '0', '$description', '$batchnumber', '$batch_quantity', '$tquantity', '$cum_quantity', '$billnumbercode', '','$batch_stockstatus', '$batch_stockstatus', '$locationcodenew', '', '$store', '', '$username', '$ipaddress', '$dateonly', '$timeonly', '$datetimeonly', '$itemmrp', '$itemsubtotal')";					$stockexecquery2=mysqli_query($GLOBALS["___mysqli_ston"], $stockquery2) or die(mysqli_error($GLOBALS["___mysqli_ston"]));						$query65="INSERT INTO master_stock (fifo_code,itemcode, itemname, transactiondate, transactionmodule, transactionparticular, billnumber, quantity, remarks, username, ipaddress, rateperunit, totalrate, companyanum, companyname, batchnumber, location, store, categoryname, locationname, locationcode, description,doc_number,physical_quantity,system_current_stock,variance) VALUES ('$fifo_code', '$itemcode', '$itemname', '$adjustmentdate', 'ADJUSTMENT', 'BY ADJUSTMENT MINUS', '$billnumbercode', '$tquantity', '$remarks', '$username', '$ipaddress', '$itemmrp', '$itemsubtotal', '$companyanum', '$companyname','$batchnumber','$location','$store','$categoryname','".$locationnamenew."','".$locationcodenew."','$description','$searchdocno','$physicalquantity','$systemcurrentstock','$variance')";						$exec65=mysqli_query($GLOBALS["___mysqli_ston"], $query65) or die(mysqli_error($GLOBALS["___mysqli_ston"]));						$updaterow = $updaterow - $tquantity;			if($batch_quantity >= $updaterow){continue;}		} 	        		}				}		$query11 = "update stock_taking set recordstatus = 'completed' where billnumber = '$searchdocno' and itemcode = '$itemcode' and auto_number = '$anum'";        $exec11 = mysqli_query($GLOBALS["___mysqli_ston"], $query11) or die(mysqli_error($GLOBALS["___mysqli_ston"]));		}		}	//exit;	header("location:directstockadjustment.php");	exit;	}if (isset($_REQUEST["st"])) { $st = $_REQUEST["st"]; } else { $st = ""; }if (isset($_REQUEST["batch"])) {  $batch = $_REQUEST["batch"]; } else { $batch = ""; }if (isset($_REQUEST["itemname"])) {  $itemname = $_REQUEST["itemname"]; } else { $itemname = ""; }//$st = $_REQUEST['st'];if ($st == '1'){	$errmsg = "Success. Payment Entry Update Completed.";}if ($st == '2'){	$errmsg = "Failed. Payment Entry Not Completed.";}?><style type="text/css"><!--body {	margin-left: 0px;	margin-top: 0px;	background-color: #ECF0F5;}.bodytext3 {	FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3B3B3C; FONT-FAMILY: Tahoma}-->.modal {    display:    none;    position:   fixed;    z-index:    1000;    top:        0;    left:       0;    height:     100%;    width:      100%;    background: rgba( 255, 255, 255, .8 )                 url('http://i.stack.imgur.com/FhHRx.gif')                 50% 50%                 no-repeat;}/* When the body has the loading class, we turn   the scrollbar off with overflow:hidden */body.loading {    overflow: hidden;   }/* Anytime the body has the loading class, our   modal element will be visible */body.loading .modal {    display: block;}</style><script src="jquery/jquery-1.11.3.min.js"></script><script language="javascript">$body = $("body");$(document).on({	    ajaxStart: function() { $body.addClass("loading");	alert('hai');	    },     ajaxStop: function() { $body.removeClass("loading"); }    });function number(event){	var charcode=(event.which)?event.which:event.keycode	if(charcode>31 && (charcode<47 || charcode >57))	{		return false;	}		return true;}function ajaxlocationfunction(val){ if (window.XMLHttpRequest)					  {// code for IE7+, Firefox, Chrome, Opera, Safari					  xmlhttp=new XMLHttpRequest();					  }					else					  {// code for IE6, IE5					  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");					  }					xmlhttp.onreadystatechange=function()					  {					  if (xmlhttp.readyState==4 && xmlhttp.status==200)						{						document.getElementById("ajaxlocation").innerHTML=xmlhttp.responseText;						}					  }					xmlhttp.open("GET","ajax/ajaxgetlocationname.php?loccode="+val,true);					xmlhttp.send();}					//ajax to get location which is selected ends herefunction cbsuppliername1(){	document.cbform1.submit();}window.onload = function () {	//var oTextbox = new AutoSuggestControl(document.getElementById("medicinename"), new StateSuggestions());        }</script><?php //include("autocompletebuild_med.php"); ?><!--<script type="text/javascript" src="js/autosuggestmed.js"></script> <script type="text/javascript" src="js/autocomplete_med.js"></script>--><script type="text/javascript">function disableEnterKey(varPassed){	//alert ("Back Key Press");	if (event.keyCode==8) 	{		event.keyCode=0; 		return event.keyCode 		return false;	}		var key;	if(window.event)	{		key = window.event.keyCode;     //IE	}	else	{		key = e.which;     //firefox	}	if(key == 13) // if enter key press	{		//alert ("Enter Key Press2");		return false;	}	else	{		return true;	}}function process1backkeypress1(){	//alert ("Back Key Press");	if (event.keyCode==8) 	{		event.keyCode=0; 		return event.keyCode 		return false;	}}function disableEnterKey(){	//alert ("Back Key Press");	if (event.keyCode==8) 	{		event.keyCode=0; 		return event.keyCode 		return false;	}		var key;	if(window.event)	{		key = window.event.keyCode;     //IE	}	else	{		key = e.which;     //firefox	}		if(key == 13) // if enter key press	{		return false;	}	else	{		return true;	}}function paymententry1process2(){	if (document.getElementById("location").value == "")	{		alert ("Please Select Location");		document.getElementById("location").focus();		return false;	}		if (document.getElementById("searchdocno").value == "")	{		alert ("Select Doc No");		document.getElementById("searchdocno").focus();		return false;	}}function funcPrintReceipt1(){	//window.open("print_bill1.php?printsource=billpage&&billautonumber="+varBillAutoNumber+"&&companyanum="+varBillCompanyAnum+"&&title1="+varTitleHeader+"&&copy1="+varPrintHeader+"&&billnumber="+varBillNumber+"","OriginalWindow<?php echo $banum; ?>",'width=722,height=950,toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=1,resizable=1,left=25,top=25');	window.open("print_payment_receipt1.php","OriginalWindow<?php echo $banum; ?>",'width=722,height=950,toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=1,resizable=1,left=25,top=25');}//ajax function to get store for corrosponding locationfunction storefunction(loc){	var username=document.getElementById("username").value;	var xmlhttp;if (window.XMLHttpRequest)  {// code for IE7+, Firefox, Chrome, Opera, Safari  xmlhttp=new XMLHttpRequest();  }else  {// code for IE6, IE5  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");  }xmlhttp.onreadystatechange=function()  {  if (xmlhttp.readyState==4 && xmlhttp.status==200)    {    document.getElementById("store").innerHTML=xmlhttp.responseText;    }  }xmlhttp.open("GET","ajax/ajaxstore.php?loc="+loc+"&username="+username,true);xmlhttp.send();	}		function functioncheklocationandstock()	{		if(document.getElementById("location").value=='')		{		alert('Please Select Location!');		document.getElementById("location").focus();		return false;		}		if(document.getElementById("store").value=='')		{		alert('Please Select Store!');		document.getElementById("store").focus();		return false;		}	}		function stockactionchange(obj,sno11)	{		var id11='addstock'+sno11;		var id12='minusstock'+sno11;		//document.getElementById(id11).value='';		//document.getElementById(id12).value='';		if(obj.value==1)		{		document.getElementById(id11).readOnly = false;		document.getElementById(id12).readOnly = false;		}		else if(obj.value==2)		{			document.getElementById(id11).readOnly = true;			document.getElementById(id12).readOnly = false;		}		else if(obj.value==3)		{			document.getElementById(id11).readOnly = true;			document.getElementById(id12).readOnly = false;		}		else		{			document.getElementById(id11).readOnly = true;			document.getElementById(id12).readOnly = true;		}	}		function checkallfunc()	{			if(document.getElementById("checkall").checked==true)		{			//document.getElementById("check").checked=true;			var checkvar = document.getElementsByClassName("check");			for(var i=0;i<checkvar.length;i++)			{				checkvar[i].checked=true;			}		}		else		{			var checkvar = document.getElementsByClassName("check");			for(var i=0;i<checkvar.length;i++)			{				checkvar[i].checked=false;			}		}	}		function chkentry(id)	{		//alert(id);		var id11='addstock'+id;		var id12='minusstock'+id;		if(document.getElementById("chk"+id).checked == false)		{			alert("Please Check Item");			document.getElementById(id11).value = '';			document.getElementById(id12).value = '';			document.getElementById("chk"+id).focus();			return false;		}		if(document.getElementById("stockaction"+id).value == "")		{			alert("Please select Action");			document.getElementById(id11).value = '';			document.getElementById(id12).value = '';			document.getElementById("stockaction"+id).focus();			return false;		}		if((document.getElementById(id11).value != "") && (document.getElementById(id12).value != ""))		{			alert("Enter Stock Add or Minus");			document.getElementById(id11).value = '';			document.getElementById(id12).value = '';			return false;		}		var variance = document.getElementById("variance"+id).value;		variance = Math.abs(variance);		if(parseFloat(document.getElementById(id11).value) > parseFloat(variance))		{			alert("Enter Correct Value");			document.getElementById(id11).value = '';			return false;		}		if(parseFloat(document.getElementById(id12).value) > parseFloat(variance))		{			alert("Enter Correct Value");			document.getElementById(id12).value = '';			return false;		}			}		function StockEntry(id)	{		var id11='addstock'+id;		var id12='minusstock'+id;		var variance = document.getElementById("variance"+id).value;		if(document.getElementById("chk"+id).checked == true)		{			if(parseFloat(variance) < 0)			{				document.getElementById(id12).value = Math.abs(variance);			}			else			{				document.getElementById(id11).value = variance;			}		}		else		{			document.getElementById(id11).value = '';			document.getElementById(id12).value = '';		}		}</script><script>		$(document).ready(function(){		//window.onbeforeunload = function(){		//		return "Your changes may not be saved.";		//}				$("#sumbitbtn1").click(function(){			window.onbeforeunload = null;   		})				$("#subbutton").click(function(){		if(document.getElementById("remarks").value == "")		{			alert("Enter Remarks");			document.getElementById("remarks").focus();			return false;		}		var sno = document.getElementById("serialno").value;		for(var j=1;j<=sno;j++)		{			if(document.getElementById("stockaction"+j) != null)			{				if(document.getElementById("chk"+j).checked == true)				{					if(document.getElementById("stockaction"+j).value == "")					{						alert("Select Action");						document.getElementById("stockaction"+j).focus();						return false;					}				}			}		}	if(confirm("Do You Want To Save The Record? ")==false) {			return false;	}else{		document.getElementById('subbutton').disabled=true;		 document.getElementById("cbform2").submit();	window.onbeforeunload = null;                               //$(window).unbind('onbeforeunload');	return true;   }});	});</script><link rel="stylesheet" type="text/css" href="css/autosuggest.css" />        <style type="text/css"><!--.bodytext3 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}.bodytext31 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}.bodytext311 {FONT-WEIGHT: normal; FONT-SIZE: 11px; COLOR: #3b3b3c; FONT-FAMILY: Tahoma; text-decoration:none}-->.bal{border-style:none;background:none;text-align:right;}.bali{text-align:right;}</style></head><script src="js/datetimepicker_css.js"></script><script type="text/javascript">	</script><!-- <body oncontextmenu="javascript:alert('Please save this form before you goto another page.');return false;"> -->	<body>	<table width="101%" border="0" cellspacing="0" cellpadding="2">  <tr>    <td colspan="10" bgcolor="#ECF0F5"><?php include ("includes/alertmessages1.php"); ?></td>  </tr>  <tr>    <td colspan="10" bgcolor="#ECF0F5"><?php include ("includes/title1.php"); ?></td>  </tr>  <tr>    <td colspan="10" bgcolor="#ECF0F5"><?php include ("includes/menu1.php"); ?></td>  </tr>  <tr>    <td colspan="10">&nbsp;</td>  </tr>  <tr>      <td width="1%">&nbsp;</td>    <td width="2%" valign="top"><?php //include ("includes/menu4.php"); ?>      &nbsp;</td>    <td width="97%" valign="top">	<table width="116%" border="0" cellspacing="0" cellpadding="0">	<tr>        <td width="860">		              <form name="cbform1" method="post" action="directstockadjustment.php" onSubmit="return paymententry1process2()">		<table width="800" border="0" align="left" cellpadding="4" cellspacing="0" bordercolor="#666666" id="AutoNumber3" style="border-collapse: collapse">          <tbody>            <tr bgcolor="#011E6A">              <td colspan="2" bgcolor="#CCCCCC" class="bodytext3"><strong>Direct Stock Adjustment </strong></td>               <td width="629" colspan="3" align="right" bgcolor="#CCCCCC" class="bodytext3" id="ajaxlocation"><strong> Location </strong>           			 <?php												if ($location!='')						{						$query12 = "select locationname from master_location where locationcode='$location' order by locationname";						$exec12 = mysqli_query($GLOBALS["___mysqli_ston"], $query12) or die ("Error in Query12".mysqli_error($GLOBALS["___mysqli_ston"]));						$res12 = mysqli_fetch_array($exec12);												echo $res1location = $res12["locationname"];						//echo $location;						}						else						{						$query1 = "select locationname from login_locationdetails where username='$username' and docno='$docno' group by locationname order by locationname";						$exec1 = mysqli_query($GLOBALS["___mysqli_ston"], $query1) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));						$res1 = mysqli_fetch_array($exec1);												echo $res1location = $res1["locationname"];						//$res1locationanum = $res1["locationcode"];						}						?>                  </td>               </tr>                     <tr>              <td colspan="2" align="left" valign="middle" bgcolor="#FFFFFF"   class="bodytext3"><strong>Location</strong></td>              <td   class="bodytext3"  colspan="3" bgcolor="#FFFFFF"><select name="location" id="location"  style="border: 1px solid #001E6A;" onChange="storefunction(this.value); ajaxlocationfunction(this.value);">                 <?php						$query = "select * from login_locationdetails where username='$username' and docno='$docno' group by locationname order by locationname";						$exec = mysqli_query($GLOBALS["___mysqli_ston"], $query) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));						while ($res = mysqli_fetch_array($exec))						{						$reslocation = $res["locationname"];						$reslocationanum = $res["locationcode"];						?>						<option value="<?php echo $reslocationanum; ?>" <?php if($location!='')if($location==$reslocationanum){echo "selected";}?>><?php echo $reslocation; ?></option>						<?php 						}						?>                  </select></td>                                <input type="hidden" name="username" id="username" value="<?php echo $username; ?>">              </tr>			<tr>              <td colspan="2" align="left" valign="middle" bgcolor="#FFFFFF"   class="bodytext3"><strong>Stock Take Ref No</strong></td>              <td   class="bodytext3"  colspan="3" bgcolor="#FFFFFF"><select name="searchdocno" id="searchdocno"  style="border: 1px solid #001E6A;">              <option value="">Select</option>                  <?php						$query = "select * from stock_taking  where recordstatus='' AND (quantity>0 or allpackagetotalquantity>0) AND location = '".$locationcode."' group by billnumber order by auto_number desc";						$exec = mysqli_query($GLOBALS["___mysqli_ston"], $query) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));						while ($res = mysqli_fetch_array($exec))						{						$billnumber = $res["billnumber"];						$transactiondate = $res['transactiondate'];						$storeref = $res['store'];												$query77 = mysqli_query($GLOBALS["___mysqli_ston"], "select store from master_store where storecode = '$storeref'") or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));						$res77 = mysqli_fetch_array($query77);						$storerefname = $res77['store'];						?>						<option value="<?php echo $billnumber; ?>" <?php if($searchdocno!='')if($searchdocno==$billnumber){echo "selected";}?>><?php echo $billnumber.' ('.$transactiondate.', '.$storerefname.')'; ?></option>						<?php 						}						?>                  </select></td>                                <input type="hidden" name="username" id="username" value="<?php echo $username; ?>">              </tr>            <tr>              <td colspan="2" align="left" valign="middle"  bgcolor="#FFFFFF" class="bodytext3"><input type="hidden" name="searchsuppliercode" onBlur="return suppliercodesearch1()" onKeyDown="return suppliercodesearch2()" id="searchsuppliercode" style="border: 1px solid #001E6A; text-transform:uppercase" value="<?php echo $searchsuppliercode; ?>" size="20" /></td>              <td colspan="3" align="left" valign="top"  bgcolor="#FFFFFF">              <input type="hidden" name="frmflag1" value="frmflag1">			  <input type="hidden" name="cbfrmflag1" value="cbfrmflag1">                  <input  style="border: 1px solid #001E6A" type="submit" id="sumbitbtn1" value="Search" name="Submit" />                  <input name="resetbutton" type="reset" id="resetbutton"  style="border: 1px solid #001E6A" value="Reset" /></td>            </tr>          </tbody>        </table>		</form>		</td>      </tr>      <tr>        <td>&nbsp;</td>      </tr>            <tr>        <td>&nbsp;</td>      </tr>     <form name="cbform2" id="cbform2" method="post" action="directstockadjustment.php">	  <tr>        <td>			<input type="hidden" name="locationcodenew" value="<?php echo $location;?>"><?php	$colorloopcount=0;if (isset($_REQUEST["cbfrmflag1"])) { $cbfrmflag1 = $_REQUEST["cbfrmflag1"]; } else { $cbfrmflag1 = ""; }//$cbfrmflag1 = $_POST['cbfrmflag1'];if ($cbfrmflag1 == 'cbfrmflag1'){?>		<table id="AutoNumber3" style="BORDER-COLLAPSE: collapse"             bordercolor="#666666" cellspacing="0" cellpadding="4" width="1100"             align="left" border="0">          <tbody>            <tr>              <td width="5%" align="left" valign="center" bordercolor="#f3f3f3"                 bgcolor="#ffffff" class="bodytext311"><strong>Check</strong>				<input type="hidden" name="checkall" id="checkall" onClick="return checkallfunc()"></td>				  <td width="6%" align="left" valign="center" bordercolor="#f3f3f3"                 bgcolor="#ffffff" class="bodytext311"><strong>Medicine Code</strong></td>              <td width="20%" align="left" valign="center" bordercolor="#f3f3f3"                 bgcolor="#ffffff" class="bodytext311"><strong>Medicine </strong></td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Action </strong></div></td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Batch </strong></div></td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Phy Qty </strong></div></td>				 <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Sys Cur Stock </strong></div></td>				 <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Variance </strong></div></td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Add Stock </strong></div></td>              <td class="bodytext31" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#ffffff"><div align="left"><strong>Minus Stock </strong></div></td>               </tr>           <?php             $sno=0;			 $i=0;			$companyanum = $_SESSION["companyanum"];						$query71 = "select auto_number,itemname,itemcode,batchnumber,quantity,store,allpackagetotalquantity,rateperunit from stock_taking where billnumber='$searchdocno' and recordstatus = '' and (quantity>0 or allpackagetotalquantity>0) order by auto_number desc";			$exec71 = mysqli_query($GLOBALS["___mysqli_ston"], $query71) or die ("Error in Query1".mysqli_error($GLOBALS["___mysqli_ston"]));				$num1 = mysqli_num_rows($exec71); 			while($res71=mysqli_fetch_array($exec71))			{			$auto_number=$res71['auto_number'];			$itemname=$res71['itemname'];			$itemcode = $res71['itemcode'];			$batchname = $res71['batchnumber'];			$physicalquantity = $res71['quantity'];			$store = $res71['store'];			$storecode = $res71['store'];			$itemrate = $res71['rateperunit'];						$check_date=date('Y-m-d');			$querybatstock2 = "select ts.itemcode as itemcode,ts.batchnumber as batchnumber,sum(ts.batch_quantity) as batch_quantity,ts.description as description,ts.fifo_code as fifo_code, pd.expirydate as expirydate from transaction_stock as ts JOIN purchase_details as pd  ON  pd.itemcode=ts.itemcode where ts.storecode='$store' and ts.locationcode='".$locationcode."' AND ts.itemcode = '$itemcode' and ts.batchnumber = '$batchname'  group by ts.itemcode";			$execbatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $querybatstock2) or die ("Error in batQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));			$execnumrows2 = mysqli_num_rows($execbatstock2);			 // echo $itemcode. "==".$execnumrows2."-------<br>";			if($execnumrows2 <= 0){				$querybatstock2 = "select ts.itemcode as itemcode,ts.batchnumber as batchnumber, sum(ts.batch_quantity) as batch_quantity,ts.description as description,ts.fifo_code as fifo_code, pd.expirydate as expirydate from transaction_stock as ts JOIN materialreceiptnote_details as pd  ON  pd.itemcode=ts.itemcode where ts.storecode='$store' and ts.locationcode='".$locationcode."' AND ts.itemcode = '$itemcode' and ts.batchnumber = '$batchname'  group by ts.itemcode";				$execbatstock2 = mysqli_query($GLOBALS["___mysqli_ston"], $querybatstock2) or die ("Error in batQuery2".mysqli_error($GLOBALS["___mysqli_ston"]));			}			while($resbatstock2 = mysqli_fetch_array($execbatstock2))			{			$batchname = $resbatstock2['batchnumber']; 			$expirydate = $resbatstock2['expirydate']; $queryexp = "select fifo_code from transaction_stock where storecode='$store' and locationcode='".$locationcode."' AND itemcode = '$itemcode' and batchnumber = '$batchname' order by auto_number desc";			$execexp = mysqli_query($GLOBALS["___mysqli_ston"], $queryexp) or die("Error in queryexp".mysqli_error($GLOBALS["___mysqli_ston"]));			$resexp = mysqli_fetch_array($execexp);			$fifo_code = $resexp['fifo_code']; 									$bat_quantity = $res71["allpackagetotalquantity"];						$currentstock = $bat_quantity;			$variance = $physicalquantity - $currentstock;						//if($currentstock > 0 )			//{			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{				//echo "if";				$colorcode = 'bgcolor="#CBDBFA"';			}			else			{				//echo "else";				$colorcode = 'bgcolor="#CBDBFA"';			}			?>           <tr <?php echo $colorcode; ?> >		     <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left">			 <?php $sno = $sno + 1; ?>			 <input type="checkbox" class="check" name="chk<?php echo $sno; ?>" id="chk<?php echo $sno; ?>" value="<?php echo $itemcode; ?>" onClick="return StockEntry('<?php echo $sno; ?>')">			 <input type="hidden" name="selectitem<?php echo $sno; ?>" value="<?php echo $itemcode; ?>">			 </td>			   <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo $itemcode; ?>			   <input type="hidden" name="fifo_code<?php echo $sno;?>" value="<?php echo $fifo_code; ?>">			   </td>				<input type="hidden" name="autonumber<?php echo $sno;?>" value="<?php echo $auto_number; ?>">								 <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo $itemname; ?>				  <input type="hidden" name="itemcode<?php echo $sno;?>" value="<?php echo $itemcode; ?>">				 <input type="hidden" name="itemname<?php echo $sno;?>" value="<?php echo $itemname; ?>">				 <input type="hidden" name="expirydate<?php echo $sno;?>" value="<?php echo $expirydate; ?>">				 <input type="hidden" name="itemrate<?php echo $sno;?>"  value="<?php echo $itemrate; ?>">				 </td>				 <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left">				 <select name="stockaction<?php echo $sno;?>" id="stockaction<?php echo $sno;?>" onChange="stockactionchange(this,<?php echo $sno;?>)">                 <option value="">--Select--</option>                 <option value="1" selected="selected">Stock Adj</option>                  <option value="2">Stock Damaged</option>                 <option value="3">Stock Expired</option>                   </select>                                </td>			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo $batchname; ?></td>				<input type="hidden" name="batch<?php echo $sno;?>" id="batch" value="<?php echo $batchname; ?>">			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo number_format($physicalquantity,0,'.',''); ?></td>			 <input type="hidden" name="physicalquantity<?php echo $sno;?>" id="physicalquantity<?php echo $sno;?>" value="<?php echo $physicalquantity; ?>">			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo $currentstock; ?></td>			   <input type="hidden" name="systemcurrentstock<?php echo $sno;?>" id="systemcurrentstock<?php echo $sno;?>" value="<?php echo $currentstock; ?>">			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><?php echo $variance; ?>			  <input type="hidden" name="variance<?php echo $sno;?>" id="variance<?php echo $sno;?>" value="<?php echo $variance; ?>"></td>			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><input type="text" size="6" onKeyPress="return number(event)" onKeyUp="return chkentry('<?php echo $sno;?>')" name="addstock<?php echo $sno;?>" id="<?php echo 'addstock'.$sno;?>" ></td>			  <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"><input type="text" size="6" name="minusstock<?php echo $sno;?>" onKeyUp="return chkentry('<?php echo $sno;?>')" onKeyPress="return number(event)" id="<?php echo 'minusstock'.$sno;?>" ></td>					   </tr>		   <?php 		   //} 		   }		   }		   ?>                       <tr>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>				<td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>                           <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>				<td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc"><div align="right"><strong>                <?php //echo number_format($totalpurchaseamount, 2); ?>              </strong></div></td>              <td class="bodytext311" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc"><div align="right"><strong>                <?php //echo number_format($netpaymentamount, 2); ?>              </strong></div></td>              <td class="bodytext311" colspan="2" valign="center" bordercolor="#f3f3f3" align="left"                 bgcolor="#cccccc">&nbsp;</td>      			</tr>			<tr>			<td align="left" valign="middle" class="bodytext3">&nbsp;</td>			<td align="left" valign="middle" class="bodytext3"><strong>Remarks</strong></td>			<td align="left" valign="middle" class="bodytext3">			<input type="hidden" name="serialno" id="serialno" value="<?php echo $sno; ?>">			<input type="hidden" name="searchdocno" value="<?php echo $searchdocno; ?>">						<input type="hidden" name="storecode" value="<?php echo $store; ?>">			<textarea cols="30" name="remarks" id="remarks"></textarea></td>			</tr>			<tr>						  <td colspan="7" class="bodytext311" valign="center" bordercolor="#f3f3f3" align="right">  <input type="hidden" name="frmflag2" value="frmflag2">                      <input name="Submit" type="submit"  value="Save" id="subbutton" class="button" style="border: 1px solid #001E6A"/>                  </td>           			</tr>          </tbody>        </table><?php}?>					</td>      </tr>      <tr>        <td>&nbsp;</td>      </tr>      <tr>        <td>&nbsp;</td>      </tr>      <tr>        <td>&nbsp;</td>      </tr>	  </form>    </table>  </table><?php include ("includes/footer1.php"); ?></body></html><script type="text/javascript">		$(document).ready(function(){		for(var i=1;i<=$("#serialno").val();i++){			$("#chk"+i).trigger('click');		}	});</script>