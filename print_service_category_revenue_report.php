<?php//include ("includes/loginverify.php");include ("db/db_connect.php");$ipaddress = $_SERVER['REMOTE_ADDR'];$updatedatetime = date('Y-m-d H:i:s');$total = '0.00';$snocount = "";$colorloopcount="";$range = "";$transactiondatefrom = date('Y-m-d', strtotime('-1 month'));$transactiondateto = date('Y-m-d');header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="service_category_revenue_report.xls"');header('Cache-Control: max-age=80'); $reportformat = "";if (isset($_REQUEST["ADate1"])) { $ADate1 = $_REQUEST["ADate1"];$transactiondatefrom = $_REQUEST['ADate1']; } else { $ADate1 = ""; }if (isset($_REQUEST["ADate2"])) { $ADate2 = $_REQUEST["ADate2"]; $transactiondateto = $_REQUEST['ADate2'];} else { $ADate2 = ""; }if (isset($_REQUEST["visitType"])) { $visittype = $_REQUEST["visitType"]; } else { $visittype = ""; }if (isset($_REQUEST["serviceCategory"])) { $servicecategory = $_REQUEST["serviceCategory"]; } else { $servicecategory = ""; }if(isset($_REQUEST['reportformat']) ){ $reportformat = $_REQUEST['reportformat'];}if (isset($_REQUEST["location"])) { $location = $_REQUEST["location"]; } else { $location = ""; }if($location=='All'){$pass_location = "locationcode !=''";}else{$pass_location = "locationcode ='$location'";}?><table  border="1" cellspacing="0" cellpadding="2"><tr><td>	<table width="100%" border="1" cellspacing="0" cellpadding="0">		<tbody>			<tr>			<td colspan="12" bgcolor="#FFFFFF" class="bodytext31" align="center" >			<?php			$query01="select companyname from master_company limit 0,1";			$res01=mysqli_query($GLOBALS["___mysqli_ston"], $query01);			$fetch01=mysqli_fetch_array($res01);			$hospitalname=$fetch01['companyname'];			echo $hospitalname."<br> &nbsp;&nbsp;&nbsp; Date Range : ".$transactiondatefrom." - ".$transactiondateto;				?>			</td>			</tr>						<?php if($reportformat == "detailed" || $reportformat == "") {?>			<tr>			<td class="bodytext31" valign="center"  align="left" bgcolor="#ffffff"><strong>No.</strong></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Visit Type </strong></div></td>			<td width="" align="left" valign="center" bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Reg. No</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Visit. No</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Patient Name</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Insurance</strong></div></td>
			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Date</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Category</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Service</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Provider</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="left"><strong>Scheme</strong></div></td>			<td width="" align="left" valign="center"  bgcolor="#ffffff" class="bodytext31"><div align="right"><strong>Amount</strong></div></td>			</tr>			    	<?php 		}		$category_condition = "";		if($servicecategory !="")		{		$category_condition = " AND master_services.categoryname = '$servicecategory' ";		}		if($visittype == "all"){		$billing_query = "SELECT auto_number,patientcode,patientvisitcode,patientfullname,billdate,categoryname,servicesitemname,amt,visittype,servicesitemcode,subtype,accountfullname  from (select billing_ipservices.auto_number,billing_ipservices.patientcode,billing_ipservices.patientvisitcode,master_ipvisitentry.patientfullname,billdate,master_services.categoryname,billing_ipservices.servicesitemname,billing_ipservices.servicesitemrate amt,@visittype:='IP' as visittype,billing_ipservices.servicesitemcode as servicesitemcode,master_ipvisitentry.subtype,master_ipvisitentry.accountfullname FROM billing_ipservices left join master_services on master_services.itemcode = billing_ipservices.servicesitemcode inner join master_ipvisitentry on master_ipvisitentry.visitcode = billing_ipservices.patientvisitcode WHERE billing_ipservices.billdate between '$ADate1' and '$ADate2' $category_condition  and billing_ipservices.$pass_location		UNION ALL SELECT    billing_paynowservices.auto_number,billing_paynowservices.patientcode,billing_paynowservices.patientvisitcode,master_visitentry.patientfullname,billdate,master_services.categoryname,billing_paynowservices.servicesitemname,billing_paynowservices.servicesitemrate amt,@visittype:='OP' as visittype,billing_paynowservices.servicesitemcode as servicesitemcode,master_visitentry.subtype,master_visitentry.accountfullname FROM billing_paynowservices left join master_services on master_services.itemcode = billing_paynowservices.servicesitemcode inner join master_visitentry on master_visitentry.visitcode = billing_paynowservices.patientvisitcode WHERE billing_paynowservices.billdate between '$ADate1' and '$ADate2' $category_condition  and billing_paynowservices.$pass_location		UNION ALL		SELECT    billing_paylaterservices.auto_number,billing_paylaterservices.patientcode,billing_paylaterservices.patientvisitcode,master_visitentry.patientfullname,billdate,master_services.categoryname,billing_paylaterservices.servicesitemname,billing_paylaterservices.servicesitemrate amt,@visittype:='OP' as visittype,billing_paylaterservices.servicesitemcode as servicesitemcode,master_visitentry.subtype,master_visitentry.accountfullname FROM billing_paylaterservices left join master_services on master_services.itemcode = billing_paylaterservices.servicesitemcode inner join master_visitentry on master_visitentry.visitcode = billing_paylaterservices.patientvisitcode WHERE billing_paylaterservices.billdate between '$ADate1' and '$ADate2' $category_condition and billing_paylaterservices.$pass_location) as a group by  patientvisitcode,servicesitemcode";		}		if($visittype == "ip"){ 		$billing_query = " SELECT auto_number,patientcode,patientvisitcode,patientfullname,billdate,categoryname,servicesitemname,amt,visittype,servicesitemcode,subtype,accountfullname  from (  select billing_ipservices.auto_number,billing_ipservices.patientcode,billing_ipservices.patientvisitcode,master_ipvisitentry.patientfullname,billdate,master_services.categoryname,billing_ipservices.servicesitemname,billing_ipservices.servicesitemrate amt,@visittype:='IP' as visittype,billing_ipservices.servicesitemcode as servicesitemcode,master_ipvisitentry.subtype,master_ipvisitentry.accountfullname FROM billing_ipservices left join master_services on master_services.itemcode = billing_ipservices.servicesitemcode inner join master_ipvisitentry on master_ipvisitentry.visitcode = billing_ipservices.patientvisitcode WHERE billing_ipservices.billdate between '$ADate1' and '$ADate2' $category_condition and billing_ipservices.$pass_location) as a group by  patientvisitcode,servicesitemcode";		}		if($visittype == "op" ){		$billing_query = "SELECT auto_number,patientcode,patientvisitcode,patientfullname,billdate,categoryname,servicesitemname,amt,visittype,servicesitemcode,subtype,accountfullname  from (  SELECT   billing_paynowservices.auto_number,billing_paynowservices.patientcode,billing_paynowservices.patientvisitcode,master_visitentry.patientfullname,billdate,master_services.categoryname,billing_paynowservices.servicesitemname,billing_paynowservices.servicesitemrate amt,@visittype:='OP' as visittype,billing_paynowservices.servicesitemcode as servicesitemcode,master_visitentry.subtype,master_visitentry.accountfullname FROM billing_paynowservices left join master_services on master_services.itemcode = billing_paynowservices.servicesitemcode inner join master_visitentry on master_visitentry.visitcode = billing_paynowservices.patientvisitcode WHERE billing_paynowservices.billdate between '$ADate1' and '$ADate2' $category_condition and billing_paynowservices.$pass_location UNION ALL		SELECT   billing_paylaterservices.auto_number,billing_paylaterservices.patientcode,billing_paylaterservices.patientvisitcode,master_visitentry.patientfullname,billdate,master_services.categoryname,billing_paylaterservices.servicesitemname,billing_paylaterservices.servicesitemrate amt,@visittype:='OP' as visittype,billing_paylaterservices.servicesitemcode as servicesitemcode,master_visitentry.subtype,master_visitentry.accountfullname FROM billing_paylaterservices left join master_services on master_services.itemcode = billing_paylaterservices.servicesitemcode inner join master_visitentry on master_visitentry.visitcode = billing_paylaterservices.patientvisitcode WHERE billing_paylaterservices.billdate between '$ADate1' and '$ADate2' $category_condition and billing_paylaterservices.$pass_location) as a group by  patientvisitcode,servicesitemcode";		}		$billing_res = mysqli_query($GLOBALS["___mysqli_ston"], $billing_query) or die ("Error in billing_query". mysqli_error($GLOBALS["___mysqli_ston"]));		$total = 0;		$records_cnt = mysqli_num_rows($billing_res);		$resdata = mysqli_fetch_array($billing_res);		while ($res= mysqli_fetch_array($billing_res))		{			$patientvisitcode= $res['patientvisitcode'];			$seritemrate=$res['amt'];			$serviceautoid=$res['auto_number'];			$accountfullname=$res['accountfullname'];			$subtype=$res['subtype'];						$querysubtype=mysqli_query($GLOBALS["___mysqli_ston"], "select * from master_subtype where auto_number='$subtype'");			$execsubtype=mysqli_fetch_array($querysubtype);			$patientsubtype1=$execsubtype['subtype'];					if($res['visittype'] == "IP"){ 			$query201 = "select pkg_status,package_process_id from billing_ipservices where Patientvisitcode = '$patientvisitcode'  and auto_number='$serviceautoid'  ";			$exec201 = mysqli_query($GLOBALS["___mysqli_ston"], $query201) or die('Error in Query201'.mysqli_error($GLOBALS["___mysqli_ston"]));			$res201 = mysqli_fetch_array($exec201);			$pkg_status = $res201['pkg_status'];			$package_process_id = $res201['package_process_id'];			if($pkg_status=='NO'){			$seritemrate=$res['amt'];			$total = $total +$seritemrate;				} elseif($pkg_status=='YES' && $package_process_id==0){			$query20 = "select packagecharge,package from master_ipvisitentry where visitcode = '$patientvisitcode' ";			$exec20 = mysqli_query($GLOBALS["___mysqli_ston"], $query20) or die('Error in Query20'.mysqli_error($GLOBALS["___mysqli_ston"]));			$res20 = mysqli_fetch_array($exec20);			$package = $res20['package'];			$seritemrate=$packagecharge = $res20['packagecharge'];			$total = $total + $packagecharge;			} else{			continue;			}			} else{			$total = $total +$res['amt'];			}			$snocount = $snocount + 1;			$colorloopcount = $colorloopcount + 1;			$showcolor = ($colorloopcount & 1); 			if ($showcolor == 0)			{			$colorcode = 'bgcolor="#CBDBFA"';			}			else			{			$colorcode = 'bgcolor="#ecf0f5"';			}			?>			<?php if($reportformat == "detailed" || $reportformat == "") {			//if($categoryname == $servicecategory) {			if($res['visittype']=='OP')			{			$usql ="select '' as doctorname from consultation_services as c  where c.patientcode='".$res['patientcode']."' and c.patientvisitcode='".$res['patientvisitcode']."' and c.servicesitemcode='".$res['servicesitemcode']."'";			}			else			{			$usql ="select d.doctorname as doctorname from ipconsultation_services as c left join master_doctor as d on c.doctorcode=d.doctorcode where c.patientcode='".$res['patientcode']."' and c.patientvisitcode='".$res['patientvisitcode']."' and c.servicesitemcode='".$res['servicesitemcode']."'";			}			$usql_res = mysqli_query($GLOBALS["___mysqli_ston"], $usql) or die ("Error in usql". mysqli_error($GLOBALS["___mysqli_ston"]));			$res_user= mysqli_fetch_array($usql_res);			$username = $res_user ['doctorname'];			?>			             <tr>                <td class="bodytext31" valign="center"  align="left"><?php echo $snocount; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['visittype']; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['patientcode']; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['patientvisitcode']; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo strtoupper($res['patientfullname']); ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['billdate']; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['categoryname']; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['servicesitemname']; ?></td>				<td class="bodytext31" valign="center"  align="left"><?php echo $patientsubtype1; ?></td>                <td class="bodytext31" valign="center"  align="left"><?php echo $res['accountfullname']; ?></td>				<td class="bodytext31" valign="center"  align="left"><?php echo $username; ?></td>                <td class="bodytext31" valign="center"  align="right"><?php echo number_format($seritemrate,2,'.',','); ?></td>              </tr>        <?php            } 		} 		?> 		<?php if($reportformat == "summary"){ 		if($records_cnt > 0){ ?>			<tr>				<td colspan="2" class="bodytext31" valign="center"  align="left" bgcolor=""><strong>Date Range: &nbsp;<?php echo $ADate1.' - '.$ADate2; ?></strong></td>				<td class="bodytext31" valign="center"  align="left" bgcolor=""><strong><?php if($visittype !="all") echo strtoupper($visittype); ?></strong></td>				<td colspan="2" class="bodytext31" valign="center"  align="left" bgcolor=""><strong><?php echo 'Total Amount'; ?></strong></td>				<td class="bodytext31" valign="center"  align="left" bgcolor=""><strong><?php echo number_format($total,2,'.',','); ?></strong></td>				<td colspan="6" class="bodytext31" valign="center"  align="left" bgcolor="">&nbsp;</td>			</tr>		<?php } 		} ?> 		<?php  		if($reportformat == "detailed" || $reportformat == "") {        if($records_cnt > 0){        ?>			<tr>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td> 				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5">&nbsp;</td>				<td class="bodytext31" valign="center"  align="left" bgcolor="#ecf0f5"> <strong> Total:</strong></td>				<td class="bodytext31" valign="center"  align="right" bgcolor="#ecf0f5"><strong><?php echo number_format($total,2,'.',','); ?></strong></td>			</tr>		<?php 			} 		}		if($records_cnt == 0){ ?>			<tr>				<td  colspan="9" class="bodytext31" valign="center"  align="center" bgcolor="#ecf0f5">No Records Found</td>			</tr>		<?php } ?>		        </tbody>        </table>		</td>      </tr></table>